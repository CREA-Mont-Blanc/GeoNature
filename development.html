<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DEVELOPPEMENT &mdash; Documentation GeoNature 2.0</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Recherche" href="search.html" />
    <link rel="next" title="COMPATIBILITE" href="versions-compatibility.html" />
    <link rel="prev" title="IMPORT NIVEAU 2" href="import-level-2.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="index.html" class="icon icon-home"> GeoNature
            <img src="_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">INSTALLATION</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-1.html">IMPORT NIVEAU 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-2.html">IMPORT NIVEAU 2</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DEVELOPPEMENT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general">Général</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api">API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#liste-des-routes">Liste des routes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#documentation-des-routes">Documentation des routes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#release">Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bdd">BDD</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pratiques-et-regles-de-developpement">Pratiques et règles de developpement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#git">Git</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backend">Backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">BDD</a></li>
<li class="toctree-l3"><a class="reference internal" href="#typescript">Typescript</a></li>
<li class="toctree-l3"><a class="reference internal" href="#angular">Angular</a></li>
<li class="toctree-l3"><a class="reference internal" href="#html">HTML</a></li>
<li class="toctree-l3"><a class="reference internal" href="#style-et-ergonomie">Style et ergonomie</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#developper-et-installer-un-gn-module">Développer et installer un gn_module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#developper-un-gn-module">Développer un gn_module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bonnes-pratiques-frontend">Bonnes pratiques Frontend</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#installer-un-gn-module">Installer un gn_module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#passer-en-mode-developpement">Passer en mode développement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#recuperation-des-sources">Récupération des sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-des-urls-de-developpement">Configuration des URLs de développement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#serveur-frontend-en-developpement">Serveur frontend en développement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-en-developpement">API en développement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#autres-extensions-en-developpement">Autres extensions en développement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debugger-avec-un-navigateur">Debugger avec un navigateur</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#developpement-backend">Développement Backend</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#demarrage-du-serveur-de-dev-backend">Démarrage du serveur de dev backend</a></li>
<li class="toctree-l3"><a class="reference internal" href="#base-de-donnees-avec-flask-sqlalchemy">Base de données avec Flask-SQLAlchemy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fonctions-de-filtrages">Fonctions de filtrages</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#serialisation-des-modeles">Serialisation des modèles</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#avec-marshmallow">Avec Marshmallow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avec-le-decorateur-serializable">Avec le décorateur <code class="docutils literal notranslate"><span class="pre">&#64;serializable</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#cas-des-modeles-geographiques">Cas des modèles géographiques</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reponses">Réponses</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#le-decorateur-json-resp">Le décorateur <code class="docutils literal notranslate"><span class="pre">&#64;json_resp</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#probleme-n-1">Problème « n+1 »</a></li>
<li class="toctree-l3"><a class="reference internal" href="#export-des-donnees">Export des données</a></li>
<li class="toctree-l3"><a class="reference internal" href="#utilisation-de-la-configuration">Utilisation de la configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authentification-et-authorisations">Authentification et authorisations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#restreindre-une-route-aux-utilisateurs-connectes">Restreindre une route aux utilisateurs connectés</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connaitre-lutilisateur-actuellement-connecte">Connaitre l’utilisateur actuellement connecté</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verification-des-droits-des-utilisateurs">Vérification des droits des utilisateurs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#developpement-frontend">Développement Frontend</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#bonnes-pratiques">Bonnes pratiques</a></li>
<li class="toctree-l3"><a class="reference internal" href="#les-composants-generiques">Les composants génériques</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#maplistcomponent">MapListComponent</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#test-end-to-end">Test end to end</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Test end to end</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#outils-d-aide-a-la-qualite-du-code">Outils d’aide à la qualité du code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sphinx">Sphinx</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pylint">Pylint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tslint">tslint</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tests-backend">Tests backend</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#utilisation">Utilisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fixtures">Fixtures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exemple">Exemple</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dans-github">Dans GitHub</a></li>
<li class="toctree-l3"><a class="reference internal" href="#coverage">Coverage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dans-vscode">Dans VSCode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#executer-un-ou-plusieurs-test-s-en-ligne-de-commande">Exécuter un ou plusieurs test(s) en ligne de commande</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tests-frontend">Tests frontend</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#redaction">Rédaction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#structure">Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Exemple</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">Exemple</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation">Implémentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">Exemple</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#lancement">Lancement</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="versions-compatibility.html">COMPATIBILITE</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">CHANGELOG</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GeoNature</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>DEVELOPPEMENT</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/development.rst.txt" rel="nofollow"> Afficher la source de la page</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developpement">
<h1>DEVELOPPEMENT<a class="headerlink" href="#developpement" title="Lien permanent vers cette rubrique"></a></h1>
<section id="general">
<h2>Général<a class="headerlink" href="#general" title="Lien permanent vers cette rubrique"></a></h2>
<p>GeoNature a été développé par Gil Deluermoz depuis 2010 avec PHP/Symfony/ExtJS.</p>
<p>En 2017, les parcs nationaux français ont décidé de refondre GeoNature
complètement avec une nouvelle version (V2) réalisée en Python/Flask/Angular.</p>
<p>Mainteneurs :</p>
<ul class="simple">
<li><p>Elie BOUTTIER (PnEcrins)</p></li>
<li><p>Theo LECHEMIA (PnEcrins)</p></li>
<li><p>Amandine SAHL (PnCevennes)</p></li>
<li><p>Camille MONCHICOURT (PnEcrins)</p></li>
</ul>
<img alt="_images/geonature-techno.png" src="_images/geonature-techno.png" />
</section>
<section id="api">
<span id="id1"></span><h2>API<a class="headerlink" href="#api" title="Lien permanent vers cette rubrique"></a></h2>
<p>GeoNature utilise :</p>
<ul class="simple">
<li><p>l’API de TaxHub (recherche taxon, règne et groupe d’un taxon…)</p></li>
<li><p>l’API du sous-module Nomenclatures (typologies et listes déroulantes)</p></li>
<li><p>l’API du sous-module d’authentification de UsersHub (login/logout, récupération du CRUVED d’un utilisateur)</p></li>
<li><p>l’API de GeoNature (get, post, update des données des différents modules, métadonnées, intersections géographiques, exports…)</p></li>
</ul>
<img alt="_images/api_services.png" src="_images/api_services.png" />
<section id="liste-des-routes">
<h3>Liste des routes<a class="headerlink" href="#liste-des-routes" title="Lien permanent vers cette rubrique"></a></h3>
<p>Vous pouvez obtenir la liste des routes de GeoNature avec la commande suivante :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ geonature routes
</pre></div>
</div>
</section>
<section id="documentation-des-routes">
<h3>Documentation des routes<a class="headerlink" href="#documentation-des-routes" title="Lien permanent vers cette rubrique"></a></h3>
<p>Génération automatique actuellement hors-service :-(</p>
</section>
</section>
<section id="release">
<h2>Release<a class="headerlink" href="#release" title="Lien permanent vers cette rubrique"></a></h2>
<p>Pour sortir une nouvelle version de GeoNature :</p>
<ul class="simple">
<li><p>Faites les éventuelles Releases des dépendances (UsersHub, TaxHub, UsersHub-authentification-module, Nomenclature-api-module, GeoNature-atlas)</p></li>
<li><p>Assurez-vous que les sous-modules git de GeoNature pointent sur les bonnes versions des dépendances</p></li>
<li><p>Mettez à jour la version de GeoNature et éventuellement des dépendances dans <code class="docutils literal notranslate"><span class="pre">install/install_all/install_all.ini</span></code>, <code class="docutils literal notranslate"><span class="pre">config/settings.ini.sample</span></code>, <code class="docutils literal notranslate"><span class="pre">backend/requirements.txt</span></code></p></li>
<li><p>Complétez le fichier <code class="docutils literal notranslate"><span class="pre">docs/CHANGELOG.rst</span></code> (en comparant les branches <a class="reference external" href="https://github.com/PnX-SI/GeoNature/compare/develop">https://github.com/PnX-SI/GeoNature/compare/develop</a>) et dater la version à sortir</p></li>
<li><p>Mettez à jour le fichier <code class="docutils literal notranslate"><span class="pre">VERSION</span></code></p></li>
<li><p>Remplissez le tableau de compatibilité des dépendances (<code class="docutils literal notranslate"><span class="pre">docs/versions-compatibility.rst</span></code>)</p></li>
<li><p>Mergez la branche <code class="docutils literal notranslate"><span class="pre">develop</span></code> dans la branche <code class="docutils literal notranslate"><span class="pre">master</span></code></p></li>
<li><p>Faites la release (<a class="reference external" href="https://github.com/PnX-SI/GeoNature/releases">https://github.com/PnX-SI/GeoNature/releases</a>) en la taguant <code class="docutils literal notranslate"><span class="pre">X.Y.Z</span></code> (sans <code class="docutils literal notranslate"><span class="pre">v</span></code> devant) et en copiant le contenu du Changelog</p></li>
<li><p>Dans la branche <code class="docutils literal notranslate"><span class="pre">develop</span></code>, modifiez le fichier <code class="docutils literal notranslate"><span class="pre">VERSION</span></code> en <code class="docutils literal notranslate"><span class="pre">X.Y.Z.dev0</span></code> et pareil dans le fichier <code class="docutils literal notranslate"><span class="pre">docs/CHANGELOG.rst</span></code></p></li>
</ul>
</section>
<section id="bdd">
<h2>BDD<a class="headerlink" href="#bdd" title="Lien permanent vers cette rubrique"></a></h2>
<p>Mettre à jour le <code class="docutils literal notranslate"><span class="pre">ref_geo</span></code> à partir des données IGN scan express :</p>
<ul class="simple">
<li><p>Télécharger le dernier millésime : <a class="reference external" href="http://professionnels.ign.fr/adminexpress">http://professionnels.ign.fr/adminexpress</a></p></li>
<li><p>Intégrer le fichier Shape dans la BDD grâce à QGIS dans une table nommée <code class="docutils literal notranslate"><span class="pre">ref_geo.temp_fr_municipalities</span></code></p></li>
<li><p>Générer le SQL de création de la table : <code class="docutils literal notranslate"><span class="pre">pg_dump</span> <span class="pre">--table=ref_geo.temp_fr_municipalities</span> <span class="pre">--column-inserts</span> <span class="pre">-U</span> <span class="pre">&lt;MON_USER&gt;</span> <span class="pre">-h</span> <span class="pre">&lt;MON_HOST&gt;</span> <span class="pre">-d</span> <span class="pre">&lt;MA_BASE&gt;</span> <span class="pre">&gt;</span> <span class="pre">fr_municipalities.sql</span></code>. Le fichier en sortie doit s’appeler <code class="docutils literal notranslate"><span class="pre">fr_municipalities.sql</span></code></p></li>
<li><p>Zipper le fichier SQL et le mettre sur le serveur <a class="reference external" href="https://geonature.fr/data">https://geonature.fr/data</a></p></li>
<li><p>Adapter le script <code class="docutils literal notranslate"><span class="pre">install_db.sh</span></code> pour récupérer le nouveau fichier zippé</p></li>
</ul>
</section>
<section id="pratiques-et-regles-de-developpement">
<h2>Pratiques et règles de developpement<a class="headerlink" href="#pratiques-et-regles-de-developpement" title="Lien permanent vers cette rubrique"></a></h2>
<p>Afin de partager des règles communes de développement et faciliter l’intégration de
nouveau code, veuillez lire les recommandations et bonnes pratiques recommandées pour contribuer
au projet GeoNature.</p>
<section id="git">
<h3>Git<a class="headerlink" href="#git" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p>Ne jamais faire de commit dans la branche <code class="docutils literal notranslate"><span class="pre">master</span></code> mais dans la branche <code class="docutils literal notranslate"><span class="pre">develop</span></code> ou idéalement dans une branche dédiée à la fonctionnalité (feature branch)</p></li>
<li><p>Faire des pull request vers la branche <code class="docutils literal notranslate"><span class="pre">develop</span></code></p></li>
<li><p>Faire des <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code> avant chaque développement et avant chaque commit</p></li>
<li><p>Les messages de commits font référence à un ticket ou le ferment (<code class="docutils literal notranslate"><span class="pre">ref</span> <span class="pre">#12</span></code> ou <code class="docutils literal notranslate"><span class="pre">fixes</span> <span class="pre">#23</span></code>)</p></li>
<li><p>Les messages des commits sont en anglais (dans la mesure du possible)</p></li>
</ul>
</section>
<section id="backend">
<h3>Backend<a class="headerlink" href="#backend" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p>Une fonction ou classe doit contenir une docstring en français. Les doctrings doivent suivre le modèle NumPy/SciPy (voir <a class="reference external" href="https://numpydoc.readthedocs.io/en/latest/format.html">https://numpydoc.readthedocs.io/en/latest/format.html</a> et <a class="reference external" href="https://realpython.com/documenting-python-code/#numpyscipy-docstrings-example">https://realpython.com/documenting-python-code/#numpyscipy-docstrings-example</a>)</p></li>
<li><p>Les commentaires dans le codes doivent être en anglais (ne pas s’empêcher de mettre un commentaire en français sur une partie du code complexe !)</p></li>
<li><p>Assurez-vous d’avoir récupérer les dépendances dans les sous-modules git : <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">init</span> <span class="pre">&amp;&amp;</span> <span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">update</span></code>
- Après un <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code>, il faut mettre à jour les sous-modules : <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">update</span></code></p></li>
<li><p>Installer les requirements-dev (<code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">backend</span> <span class="pre">&amp;&amp;</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements-dev.txt</span></code>) qui contiennent une série d’outils indispensables au développement dans GeoNature.</p></li>
<li><p>Utiliser <em>blake</em> comme formateur de texte et activer l’auto-formatage dans son éditeur de texte (Tuto pour VsCode : <a class="reference external" href="https://medium.com/&#64;marcobelo/setting-up-python-black-on-visual-studio-code-5318eba4cd00">https://medium.com/&#64;marcobelo/setting-up-python-black-on-visual-studio-code-5318eba4cd00</a>)</p></li>
<li><p>Utiliser <em>pylint</em> comme formatteur de code</p></li>
<li><p>Respecter la norme PEP8 (assurée par les deux outils précédents)</p></li>
<li><p>La longueur maximale pour une ligne de code est 100 caractères. Pour VsCode copier ces lignes le fichier <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> :</p></li>
<li><p>Respecter le snake case</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;python.formatting.blackArgs&quot;</span><span class="p">:</span> <span class="p">[</span>
  <span class="s2">&quot;--line-length&quot;</span><span class="p">,</span>
  <span class="s2">&quot;100&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Utiliser des doubles quotes pour les chaines de charactères.</p></li>
</ul>
</section>
<section id="id2">
<h3>BDD<a class="headerlink" href="#id2" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p>Le noms des tables est préfixé par un « t » pour une table de contenu, de « bib » pour les tables de « dictionnaires » et de « cor » pour les tables de correspondance (relations N-N)</p></li>
<li><p>Les schémas du coeur de GeoNature sont préfixés de « gn »</p></li>
<li><p>Les schémas des protocoles ou modules GeoNature sont préfixés de « pr »</p></li>
<li><p>Ne rien écrire dans le schéma <code class="docutils literal notranslate"><span class="pre">public</span></code></p></li>
<li><p>Ne pas répeter le nom des tables dans les noms des colonnes</p></li>
</ul>
</section>
<section id="typescript">
<h3>Typescript<a class="headerlink" href="#typescript" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p>Documenter les fonctions et classes grâce au JSDoc en français (<a class="reference external" href="https://jsdoc.app/">https://jsdoc.app/</a>)</p></li>
<li><p>Les commentaires dans le codes doivent être en anglais (ne pas s’empêcher de mettre un commentaire en français sur une partie du code complexe !)</p></li>
<li><p>Les messages renvoyés aux utilisateurs sont en français</p></li>
<li><p>Installer les outils de devéloppement : <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">--only=dev</span></code></p></li>
<li><p>Utiliser <em>prettier</em> comme formateur de texte et activer l’autoformatage dans son éditeur de texte (VsCode dispose d’une extension Prettier : <a class="reference external" href="https://github.com/prettier/prettier-vscode">https://github.com/prettier/prettier-vscode</a>)</p></li>
<li><p>Utiliser <code class="docutils literal notranslate"><span class="pre">tslint</span></code> comme linter</p></li>
<li><p>La longueur maximale pour une ligne de code est 100 caractères.</p></li>
</ul>
</section>
<section id="angular">
<h3>Angular<a class="headerlink" href="#angular" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p>Suivre les recommandations définies par le styleguide Angular: <a class="reference external" href="https://angular.io/guide/styleguide">https://angular.io/guide/styleguide</a>. C’est une ressources très fournie en cas de question sur les pratiques de développement (principe de séparation des principes, organisation des services et des composants)</p></li>
<li><p>On privilégiera l’utilisation des reactive forms pour la construction des formulaires (<a class="reference external" href="https://angular.io/guide/reactive-forms">https://angular.io/guide/reactive-forms</a>). Ce sont des formulaires pilotés par le code, ce qui facilite la lisibilité et le contrôle de ceux-ci.</p></li>
<li><p>Pour l’ensemble des composants cartographiques et des formulaires (taxonomie, nomenclatures…), il est conseillé d’utiliser les composants présents dans le module “GN2CommonModule”.</p></li>
</ul>
</section>
<section id="html">
<h3>HTML<a class="headerlink" href="#html" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p>La longueur maximale pour une ligne de code est 100 caractères.</p></li>
<li><p>Lorsqu’il y a plus d’un attribut sur une balise, revenir à la ligne et aligner les attributs :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">button</span>
  <span class="n">mat</span><span class="o">-</span><span class="n">raised</span><span class="o">-</span><span class="n">button</span>
  <span class="n">color</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span>
  <span class="n">class</span><span class="o">=</span><span class="s2">&quot;btn-action hard-shadow uppercase ml-3&quot;</span>
  <span class="n">data</span><span class="o">-</span><span class="n">toggle</span><span class="o">=</span><span class="s2">&quot;collapse&quot;</span>
  <span class="n">data</span><span class="o">-</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;#collapseAvance&quot;</span>
<span class="o">&gt;</span>
  <span class="n">Filtrer</span>
<span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>VsCode fournit un formatteur de HTML par défaut (Dans les options de VsCode, tapez « wrap attributes » et sélectionner « force-expand-multiline »)</p></li>
</ul>
</section>
<section id="style-et-ergonomie">
<h3>Style et ergonomie<a class="headerlink" href="#style-et-ergonomie" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p>Boutons :
On utilise les boutons d’Angular materials (<a class="reference external" href="https://material.angular.io/components/button/overview">https://material.angular.io/components/button/overview</a>).</p>
<ul>
<li><p>mat-raised-button pour les boutons contenant du texte</p></li>
<li><p>mat-fab ou mat-mini-fab pour les boutons d’actions avec seulement une icone</p></li>
</ul>
</li>
<li><p>Couleur des boutons :</p>
<ul>
<li><p>Action : primary</p></li>
<li><p>Validation: vert (n’existant pas dans material: utiliser la classe <cite>button-success</cite>)</p></li>
<li><p>Suppression: warn</p></li>
<li><p>Navigation: basic</p></li>
</ul>
</li>
<li><p>Librairie d’icones :</p>
<ul>
<li><p>Utiliser la librairie material icons fournie avec le projet : <a class="reference external" href="https://material.io/resources/icons/?style=baseline">https://material.io/resources/icons/?style=baseline</a> (<code class="docutils literal notranslate"><span class="pre">&lt;mat-icon&gt;</span> <span class="pre">add</span> <span class="pre">&lt;/mat-icon&gt;</span></code>)</p></li>
</ul>
</li>
<li><p>Formulaire :</p>
<ul>
<li><p>Nous utilisons pour l’instant le style des formulaires Bootstrap (<a class="reference external" href="https://getbootstrap.com/docs/4.0/components/forms/">https://getbootstrap.com/docs/4.0/components/forms/</a>). Une reflexion de migration vers les formulaires materials est en cours.</p></li>
</ul>
</li>
<li><p>Système de grille et responsive :</p>
<ul>
<li><p>Utiliser le système de grille de bootstrap pour assurer le responsive design sur l’application. On ne vise pas l’utilisation sur mobile, mais à minima sur ordinateur portable de petite taille.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="developper-et-installer-un-gn-module">
<h2>Développer et installer un gn_module<a class="headerlink" href="#developper-et-installer-un-gn-module" title="Lien permanent vers cette rubrique"></a></h2>
<p>GeoNature a été conçu pour fonctionner en briques modulaires.</p>
<p>Chaque protocole, répondant à une question scientifique, est amené à avoir
son propre module GeoNature comportant son modèle de base de données (dans un
schéma séparé), son API et son interface utilisateur.</p>
<p>Les modules développés s’appuieront sur le coeur de GeoNature qui est
constitué d’un ensemble de briques réutilisables.</p>
<p>En base de données, le coeur de GeoNature est constitué de l’ensemble des
référentiels (utilisateurs, taxonomique, nomenclatures géographique)
et du schéma <code class="docutils literal notranslate"><span class="pre">gn_synthese</span></code> regroupant l’ensemble données saisies dans les
différents protocoles (voir doc administrateur pour plus de détail sur le
modèle de données).</p>
<p>L’API du coeur permet d’interroger les schémas de la base de données « coeur »
de GeoNature. Une documentation complète de l’API est disponible dans la
rubrique <a class="reference internal" href="#api"><span class="std std-ref">API</span></a>.</p>
<p>Du côté interface utilisateur, GeoNature met à disposition un ensemble de
composants Angular réutilisables
(<a class="reference external" href="http://pnx-si.github.io/GeoNature/frontend/modules/GN2CommonModule.html">http://pnx-si.github.io/GeoNature/frontend/modules/GN2CommonModule.html</a>),
pour l’affichage des cartes, des formulaires etc…</p>
<section id="developper-un-gn-module">
<h3>Développer un gn_module<a class="headerlink" href="#developper-un-gn-module" title="Lien permanent vers cette rubrique"></a></h3>
<p>Avant de développer un gn_module, assurez-vous d’avoir GeoNature bien
installé sur votre machine (voir <a class="reference internal" href="installation.html#installation-standalone"><span class="std std-ref">Installation de GeoNature uniquement</span></a>).</p>
<p>Afin de pouvoir connecter ce module au « coeur », il est impératif de suivre
une arborescence prédéfinie par l’équipe GeoNature.
Un template GitHub a été prévu à cet effet
(<a class="reference external" href="https://github.com/PnX-SI/gn_module_template">https://github.com/PnX-SI/gn_module_template</a>).
Il est possible de créer un nouveau dépôt GitHub à partir de ce template,
ou alors de copier/coller le contenu du dépôt dans un nouveau.</p>
<p>Cette arborescence implique de développer le module dans les technologies du
coeur de GeoNature à savoir :</p>
<ul class="simple">
<li><p>Le backend est développé en Python grâce au framework Flask.</p></li>
<li><p>Le frontend est développé grâce au framework Angular (voir la version actuelle du coeur)</p></li>
</ul>
<p>GeoNature prévoit cependant l’intégration de module « externe » dont le
frontend serait développé dans d’autres technologies. La gestion de
l’intégration du module est à la charge du développeur.</p>
<ul class="simple">
<li><p>Le module se placera dans un dossier à part du dossier « GeoNature » et portera le suffixe « gn_module ». Exemple : <em>gn_module_validation</em></p></li>
<li><p>La racine du module comportera les fichiers suivants :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">install_app.sh</span></code> : script bash d’installation des librairies python ou npm necessaires au module</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">install_env.sh</span></code> : script bash d’installation des paquets Linux</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> : liste des librairies python necessaires au module</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">manifest.toml</span></code> : fichier de description du module (nom, version du module, version de GeoNature compatible)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">conf_gn_module.toml</span></code> : fichier de configuration de l’application (livré en version sample)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">conf_schema_toml.py</span></code> : schéma “marshmallow” (<a class="reference external" href="https://marshmallow.readthedocs.io/en/latest/">https://marshmallow.readthedocs.io/en/latest/</a>) du fichier de configuration (permet de s’assurer la conformité des paramètres renseignés par l’utilisateur). Ce fichier doit contenir une classe <code class="docutils literal notranslate"><span class="pre">GnModuleSchemaConf</span></code> dans laquelle toutes les configurations sont synchronisées.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">install_gn_module.py</span></code> : script python lançant les commandes relatives à “installation du module (Base de données, …). Ce fichier doit comprendre une fonction <code class="docutils literal notranslate"><span class="pre">gnmodule_install_app(gn_db,</span> <span class="pre">gn_app)</span></code> qui est utilisée pour installer le module (Voir l”<a class="reference external" href="https://github.com/PnX-SI/gn_module_cmr/blob/master/install_gn_module.py">exemple du module CMR</a>)</p></li>
</ul>
</li>
<li><p>La racine du module comportera les dossiers suivants :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">backend</span></code> : dossier comportant l’API du module utilisant un blueprint Flask</p></li>
<li><p>Le fichier <code class="docutils literal notranslate"><span class="pre">blueprint.py</span></code> comprend les routes du module (ou instancie les nouveaux blueprints du module)</p></li>
<li><p>Le fichier <code class="docutils literal notranslate"><span class="pre">models.py</span></code> comprend les modèles SQLAlchemy des tables du module.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">frontend</span></code> : le dossier <code class="docutils literal notranslate"><span class="pre">app</span></code> comprend les fichiers typescript du module, et le dossier <code class="docutils literal notranslate"><span class="pre">assets</span></code> l’ensemble des médias (images, son).</p>
<ul>
<li><p>Le dossier <code class="docutils literal notranslate"><span class="pre">app</span></code> doit comprendre le « module Angular racine », celui-ci doit impérativement s’appeler <code class="docutils literal notranslate"><span class="pre">gnModule.module.ts</span></code></p></li>
<li><p>Le dossier <code class="docutils literal notranslate"><span class="pre">app</span></code> doit contenir un fichier <code class="docutils literal notranslate"><span class="pre">module.config.ts</span></code>. Ce fichier est automatiquement synchronisé avec le fichier de configuration du module <cite>&lt;GEONATURE_DIRECTORY&gt;/external_modules/&lt;nom_module&gt;/conf_gn_module.toml`</cite> grâce à la commande <code class="docutils literal notranslate"><span class="pre">geonature</span> <span class="pre">update_module_configuration</span> <span class="pre">&lt;nom_module&gt;</span></code>. C’est à partir de ce fichier que toutes les configuration doivent pointer.</p></li>
<li><p>A la racine du dossier <code class="docutils literal notranslate"><span class="pre">frontend</span></code>, on retrouve également un fichier <code class="docutils literal notranslate"><span class="pre">package.json</span></code> qui décrit l’ensemble des librairies JS necessaires au module.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> : ce dossier comprenant les scripts SQL d’installation du module</p></li>
</ul>
</li>
</ul>
<p>Le module est ensuite installable à la manière d’un plugin grâce à la commande <code class="docutils literal notranslate"><span class="pre">geonature</span> <span class="pre">install_gn_module</span></code> de la manière suivante :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># se placer dans le répertoire backend de GeoNature</span>
<span class="n">cd</span> <span class="o">&lt;</span><span class="n">GEONATURE_DIRECTORY</span><span class="o">&gt;/</span><span class="n">backend</span>
<span class="c1"># activer le virtualenv python</span>
<span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="c1"># lancer la commande d&#39;installation</span>
<span class="n">geonature</span> <span class="n">install_gn_module</span> <span class="o">&lt;</span><span class="n">CHEMIN_ABSOLU_DU_MODULE</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">URL_API</span><span class="o">&gt;</span>
<span class="c1"># example geonature install_gn_module /home/moi/gn_module_validation /validation</span>
</pre></div>
</div>
<section id="bonnes-pratiques-frontend">
<h4>Bonnes pratiques Frontend<a class="headerlink" href="#bonnes-pratiques-frontend" title="Lien permanent vers cette rubrique"></a></h4>
<ul>
<li><p>Pour l’ensemble des composants cartographiques et des formulaires (taxonomie, nomenclatures…), il est conseillé d’utiliser les composants présents dans le module “GN2CommonModule”.</p>
<p>Importez ce module dans le module racine de la manière suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">{</span> <span class="n">GN2CommonModule</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;@geonature_common/GN2Common.module&#39;</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Les librairies JS seront installées dans le dossier <code class="docutils literal notranslate"><span class="pre">node_modules</span></code> de GeoNature. (Il n’est pas nécessaire de réinstaller toutes les librairies déjà présentes dans GeoNature (Angular, Leaflet, ChartJS …). Le <code class="docutils literal notranslate"><span class="pre">package.json</span></code> de GeoNature liste l’ensemble des librairies déjà installées et réutilisable dans le module.</p></li>
<li><p>Les fichiers d’assets sont à ranger dans le dossier <code class="docutils literal notranslate"><span class="pre">assets</span></code> du frontend. Angular-cli impose cependant que tous les assets soient dans le répertoire mère de l’application (celui de GeoNature). Un lien symbolique est créé à l’installation du module pour faire entre le dossier d’assets du module et celui de Geonature.</p></li>
<li><p>Utiliser node_modules présent dans GeoNature</p>
<p>Pour utiliser des librairies déjà installées dans GeoNature,
utilisez la syntaxe suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">{</span> <span class="n">TreeModule</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@librairies/angular-tree-component&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>L’alias <code class="docutils literal notranslate"><span class="pre">&#64;librairies</span></code> pointe en effet vers le repertoire des node_modules
de GeoNature</p>
<p>Pour les utiliser à l’interieur du module, utiliser la syntaxe suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;external_assets/&lt;MY_MODULE_CODE&gt;/afb.png&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Exemple pour le module de validation</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;external_assets/&lt;gn_module_validation&gt;/afb.png&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="installer-un-gn-module">
<h3>Installer un gn_module<a class="headerlink" href="#installer-un-gn-module" title="Lien permanent vers cette rubrique"></a></h3>
<p>Renseignez l’éventuel fichier <code class="docutils literal notranslate"><span class="pre">config/settings.ini</span></code> du module.</p>
<p>Pour installer un module, rendez vous dans le dossier <code class="docutils literal notranslate"><span class="pre">backend</span></code> de GeoNature.</p>
<p>Activer ensuite le virtualenv pour rendre disponible les commandes GeoNature</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
</pre></div>
</div>
<p>Lancez ensuite la commande</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geonature</span> <span class="n">install_gn_module</span> <span class="o">&lt;</span><span class="n">mon_chemin_absolu_vers_le_module</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">url_api</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Le premier paramètre est l’emplacement absolu du module sur votre machine et
le 2ème le chemin derrière lequel on retrouvera les routes de l’API du module.</p>
<p>Exemple pour atteindre les routes du module de validation à l’adresse
“<a class="reference external" href="http://mon-geonature.fr/api/geonature/validation">http://mon-geonature.fr/api/geonature/validation</a>”</p>
<p>Cette commande exécute les actions suivantes :</p>
<ul class="simple">
<li><p>Vérification de la conformité de la structure du module (présence des fichiers et dossiers obligatoires)</p></li>
<li><p>Intégration du blueprint du module dans l’API de GeoNature</p></li>
<li><p>Vérification de la conformité des paramètres utilisateurs</p></li>
<li><p>Génération du routing Angular pour le frontend</p></li>
<li><p>Re-build du frontend pour une mise en production</p></li>
</ul>
<p>Complétez l’éventuelle configuration du module (<code class="docutils literal notranslate"><span class="pre">config/conf_gn_module.toml</span></code>)
à partir des paramètres présents dans
<code class="docutils literal notranslate"><span class="pre">config/conf_gn_module.toml.example</span></code> dont vous pouvez surcoucher les
valeurs par défaut. Puis relancez la mise à jour de la configuration
(depuis le répertoire <code class="docutils literal notranslate"><span class="pre">geonature/backend</span></code> et une fois dans le venv
(<code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">venv/bin/activate</span></code>) :
<code class="docutils literal notranslate"><span class="pre">geonature</span> <span class="pre">update_module_configuration</span> <span class="pre">nom_du_module</span></code>)</p>
</section>
</section>
<section id="passer-en-mode-developpement">
<span id="mode-dev"></span><h2>Passer en mode développement<a class="headerlink" href="#passer-en-mode-developpement" title="Lien permanent vers cette rubrique"></a></h2>
<section id="recuperation-des-sources">
<h3>Récupération des sources<a class="headerlink" href="#recuperation-des-sources" title="Lien permanent vers cette rubrique"></a></h3>
<p>Si vous avez téléchargé GeoNature zippé (via la procédure d’installation globale <code class="docutils literal notranslate"><span class="pre">install_all.sh</span></code> ou en suivant la documentation d’installation standalone), il est nécessaire de rattacher votre répertoire au dépôt GitHub afin de pouvoir télécharger les dernières avancées du coeur en <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code>. Pour cela, suivez les commandes suivantes en vous placant à la racine du répertoire de GeoNature.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--- Se créer un répertoire .git ---
mkdir .git
---  récupérer l<span class="s1">&#39;historique du dépôt ---</span>
<span class="s1">git clone --depth=2 --bare https://github.com/PnX-SI/GeoNature.git .git</span>
<span class="s1">--- initialiser un dépôt git à partir de l&#39;</span>historique téléchargé ---
git init
--- vérifier que le dépôt distant et le contenu <span class="nb">local</span> sont synchronisés ---
git pull
--- Reset sur HEAD pour mettre à jour les status ---
git reset HEAD
-&gt; vous êtes à jour sur la branche master
--- Cloner les sous-modules pour récupérer les dépendances
git submodule init
git submodule update
</pre></div>
</div>
</section>
<section id="configuration-des-urls-de-developpement">
<h3>Configuration des URLs de développement<a class="headerlink" href="#configuration-des-urls-de-developpement" title="Lien permanent vers cette rubrique"></a></h3>
<p>il est nécessaire de changer la configuration du fichier <code class="docutils literal notranslate"><span class="pre">config/geonature_config.toml</span></code> pour utiliser les adresses suivantes :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">URL_APPLICATION</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:4200&#39;</span>
<span class="nv">API_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:8000&#39;</span>
<span class="nv">API_TAXHUB</span> <span class="o">=</span>  <span class="s1">&#39;http://127.0.0.1:5000/api&#39;</span>
</pre></div>
</div>
<p>N’oubliez pas les <a class="reference internal" href="admin-manual.html#post-config-change"><span class="std std-ref">actions à effecture après modification de la configuration</span></a>.</p>
</section>
<section id="serveur-frontend-en-developpement">
<h3>Serveur frontend en développement<a class="headerlink" href="#serveur-frontend-en-developpement" title="Lien permanent vers cette rubrique"></a></h3>
<p>Lancer le serveur frontent via le virtualenv :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> ~/geonature/frontend/
nvm use
npm run start
</pre></div>
</div>
</section>
<section id="api-en-developpement">
<h3>API en développement<a class="headerlink" href="#api-en-developpement" title="Lien permanent vers cette rubrique"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Retrouvez plus de’informations dans la section <a class="reference internal" href="#dev-backend"><span class="std std-ref">Développement Backend</span></a> dédiée.</p>
</div>
<p>Dans un nouveau terminal, stopper le service geonature (gunicorn) et lancer le serveur backend :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl stop geonature
<span class="nb">source</span> ~/geonature/backend/venv/bin/activate
geonature dev_back
</pre></div>
</div>
<dl class="simple">
<dt>Les serveurs seront accessibles via ces adresses (login <code class="docutils literal notranslate"><span class="pre">admin</span></code> et password <code class="docutils literal notranslate"><span class="pre">admin</span></code>) :</dt><dd><ul class="simple">
<li><p>backend - 127.0.0.1:8000</p></li>
<li><p>frontend - 127.0.0.1:4200</p></li>
</ul>
</dd>
</dl>
</section>
<section id="autres-extensions-en-developpement">
<h3>Autres extensions en développement<a class="headerlink" href="#autres-extensions-en-developpement" title="Lien permanent vers cette rubrique"></a></h3>
<p>Il n’est pas forcémment utile de passer toutes les extensions en mode dévelomment.
Pour plus d’informations, référez-vous aux documentations dédiées :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://taxhub.readthedocs.io/fr/latest/installation.html#developpement">https://taxhub.readthedocs.io/fr/latest/installation.html#developpement</a></p></li>
<li><p><a class="reference external" href="https://usershub.readthedocs.io/fr/latest/">https://usershub.readthedocs.io/fr/latest/</a></p></li>
</ul>
<p>Si toutefois TaxHub retourne une erreur 500 et ne répond pas sur l’URL <a class="reference external" href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> alors vous pouvez avoir besoin de passer TaxHub en mode développement :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> ~/taxhub/venv/bin/activate
flask run
</pre></div>
</div>
</section>
<section id="debugger-avec-un-navigateur">
<h3>Debugger avec un navigateur<a class="headerlink" href="#debugger-avec-un-navigateur" title="Lien permanent vers cette rubrique"></a></h3>
<p>L’extension <a class="reference external" href="https://angular.io/guide/devtools">Angular DevTools</a> permettra de debugger l’application dans la console du navigateur.
Pour utiliser l’extension vous devez l’installer et passer obligatoirement en mode <code class="docutils literal notranslate"><span class="pre">development</span></code>.</p>
<p>Ouvrez le fichier  <code class="docutils literal notranslate"><span class="pre">frontend/src/conf/app.config.ts</span></code> et modifiez la valeur <code class="docutils literal notranslate"><span class="pre">PROD_MOD</span></code> pour avoir :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="s2">&quot;PROD_MOD&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
</pre></div>
</div>
<p>Si le mode production (PROD_MOD) est à true, alors vous n’êtes pas en mode production lors du lancement de la commande <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">run</span> <span class="pre">start</span></code>.</p>
</section>
</section>
<section id="developpement-backend">
<span id="dev-backend"></span><h2>Développement Backend<a class="headerlink" href="#developpement-backend" title="Lien permanent vers cette rubrique"></a></h2>
<section id="demarrage-du-serveur-de-dev-backend">
<h3>Démarrage du serveur de dev backend<a class="headerlink" href="#demarrage-du-serveur-de-dev-backend" title="Lien permanent vers cette rubrique"></a></h3>
<p>La commande <code class="docutils literal notranslate"><span class="pre">geonature</span></code> fournit la sous-commande <code class="docutils literal notranslate"><span class="pre">dev_back</span></code> pour lancer un serveur de test :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv)...$ geonature dev_back
</pre></div>
</div>
</section>
<section id="base-de-donnees-avec-flask-sqlalchemy">
<h3>Base de données avec Flask-SQLAlchemy<a class="headerlink" href="#base-de-donnees-avec-flask-sqlalchemy" title="Lien permanent vers cette rubrique"></a></h3>
<p>L’intégration de la base de données à GeoNature repose sur la bibliothèque <a class="reference external" href="https://flask-sqlalchemy.palletsprojects.com">Flask-SQLAlchemy</a>.</p>
<p>Celle-ci fournit un objet <code class="docutils literal notranslate"><span class="pre">db</span></code> à importer comme ceci : <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">geonature.utils.env</span> <span class="pre">import</span> <span class="pre">db</span></code></p>
<p>Cet objet permet d’accéder à la session SQLAlchemy ainsi :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">db</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Mais il fournit une base déclarative <code class="docutils literal notranslate"><span class="pre">db.Model</span></code> permettant d’interroger encore plus simplement les modèles via leur attribut <code class="docutils literal notranslate"><span class="pre">query</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>from geonature.utils.env import db
class MyModel(db.Model):
    …

obj = MyModel.query.get(1)
</pre></div>
</div>
<p>L’attribut <code class="docutils literal notranslate"><span class="pre">query</span></code> fournit <a class="reference external" href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/api/#flask_sqlalchemy.BaseQuery">plusieurs fonctions</a> très utiles dont la fonction <code class="docutils literal notranslate"><span class="pre">get_or_404</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Ceci est typiquement la première ligne de toutes les routes travaillant sur une instance (route de type get/update/delete).</p>
<section id="fonctions-de-filtrages">
<h4>Fonctions de filtrages<a class="headerlink" href="#fonctions-de-filtrages" title="Lien permanent vers cette rubrique"></a></h4>
<p>L’attribut <code class="docutils literal notranslate"><span class="pre">query</span></code> est une instance de la classe <code class="docutils literal notranslate"><span class="pre">flask_sqlalchemy.BaseQuery</span></code> qui peut être sur-chargée afin de définir de nouvelles fonctions de filtrage.</p>
<p>On pourra ainsi implémenter une fonction pour filtrer les objets auxquels l’utilisateur a accès, ou encore pour implémenter des filtres de recherche.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">BaseQuery</span>
<span class="kn">from</span> <span class="nn">geonature.core.gn_permissions</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="k">class</span> <span class="nc">MyModelQuery</span><span class="p">(</span><span class="n">BaseQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">filter_by_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">false</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">owner</span><span class="o">==</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">id_organism</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">id_organism</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">id_organism</span><span class="p">)</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">query_class</span> <span class="o">=</span> <span class="n">MyModelQuery</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">list_my_model</span><span class="p">():</span>
    <span class="n">obj_list</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by_scope</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="serialisation-des-modeles">
<h3>Serialisation des modèles<a class="headerlink" href="#serialisation-des-modeles" title="Lien permanent vers cette rubrique"></a></h3>
<section id="avec-marshmallow">
<h4>Avec Marshmallow<a class="headerlink" href="#avec-marshmallow" title="Lien permanent vers cette rubrique"></a></h4>
<p>La bibliothèque <a class="reference external" href="https://marshmallow.readthedocs.io/en/stable/">Marshmallow</a> fournit des outils de sérialisation et desérialisation.</p>
<p>Elle est intégrée à GeoNature par la bibliothèque <a class="reference external" href="https://flask-marshmallow.readthedocs.io/en/latest/">Flask-Marshmallow</a> qui fournit l’objet <code class="docutils literal notranslate"><span class="pre">ma</span></code> à importer comme ceci : <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">geonature.utils.env</span> <span class="pre">import</span> <span class="pre">ma</span></code>.</p>
<p>Cette bibliothèque ajoute notablement une méthode <code class="docutils literal notranslate"><span class="pre">jsonify</span></code> aux schémas.</p>
<p>Les schémas Marshmallow peuvent être facilement créés à partir des modèles SQLAlchemy grâce à la bibliothèque <a class="reference external" href="https://marshmallow-sqlalchemy.readthedocs.io/en/latest/">Marshmallow-SQLAlchemy</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>La propriété <code class="docutils literal notranslate"><span class="pre">include_fk=True</span></code> concerne les champs de type <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code>, mais pas les <code class="docutils literal notranslate"><span class="pre">relationships</span></code> en elles-même. Pour ces dernières, il est nécessaire d’ajouter manuellement des champs <code class="docutils literal notranslate"><span class="pre">Nested</span></code> à son schéma :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ParentModelSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ParentModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">childs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="s2">&quot;ChildModelSchema&quot;</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChildModelSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ChildModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="n">ParentModelSchema</span><span class="p">)</span>
</pre></div>
</div>
<p>Attention, la sérialisation d’un objet avec un tel schéma va provoquer une récursion infinie, le schéma parent incluant le schéma enfant, et le schéma enfant incluant le schéma parent.</p>
<p>Il est donc nécessaire de restreindre les champs à inclure avec l’argument <code class="docutils literal notranslate"><span class="pre">only</span></code> ou <code class="docutils literal notranslate"><span class="pre">exclude</span></code> lors de la création des schémas :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parent_schema</span> <span class="o">=</span> <span class="n">ParentModelSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;childs.pk&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>L’utilisation de <code class="docutils literal notranslate"><span class="pre">only</span></code> est lourde puisqu’il faut re-spécifier tous les champs à sérialiser. On est alors tenté d’utiliser l’argument <code class="docutils literal notranslate"><span class="pre">exclude</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parent_schema</span> <span class="o">=</span> <span class="n">ParentModelSchema</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;childs.parent&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Cependant, l’utilisation de <code class="docutils literal notranslate"><span class="pre">exclude</span></code> est hautement problématique !</p>
<p>En effet, l’ajout d’un nouveau champs <code class="docutils literal notranslate"><span class="pre">Nested</span></code> au schéma nécessiterait de le rajouter dans la liste des exclusions partout où le schéma est utilisé (que ça soit pour éviter une récursion infinie, d’alourdir une réponse JSON avec des données inutiles ou pour éviter un problème n+1 - voir section dédiée).</p>
<p>La bibliothèque Utils-Flask-SQLAlchemy fournit une classe utilitaire <code class="docutils literal notranslate"><span class="pre">SmartRelationshipsMixin</span></code> permettant de résoudre ces problématiques.</p>
<p>Elle permet d’exclure par défaut les champs <code class="docutils literal notranslate"><span class="pre">Nested</span></code>.</p>
<p>Pour demander la sérialisation d’un sous-schéma, il faut le spécifier avec <code class="docutils literal notranslate"><span class="pre">only</span></code>, mais sans nécessité de spécifier tous les champs basiques (non <code class="docutils literal notranslate"><span class="pre">Nested</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils_flask_sqla.schema</span> <span class="kn">import</span> <span class="n">SmartRelationshipsMixin</span>

<span class="k">class</span> <span class="nc">ParentModelSchema</span><span class="p">(</span><span class="n">SmartRelationshipsMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ParentModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">childs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="s2">&quot;ChildModelSchema&quot;</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChildModelSchema</span><span class="p">(</span><span class="n">SmartRelationshipsMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ChildModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="n">ParentModelSchema</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="avec-le-decorateur-serializable">
<h4>Avec le décorateur <code class="docutils literal notranslate"><span class="pre">&#64;serializable</span></code><a class="headerlink" href="#avec-le-decorateur-serializable" title="Lien permanent vers cette rubrique"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>L’utilisation des schémas Marshmallow est probablement plus performante.</p>
</div>
<p>La bibliothèque maison <a class="reference external" href="https://github.com/PnX-SI/Utils-Flask-SQLAlchemy">Utils-Flask-SQLAlchemy</a> fournit le décorateur <code class="docutils literal notranslate"><span class="pre">&#64;serializable</span></code> qui ajoute une méthode <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> sur les modèles décorés :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>from utils_flask_sqla.serializers import serializable

@serializable
class MyModel(db.Model):
    …


obj = MyModel(…)
obj.as_dict()
</pre></div>
</div>
<p>La méthode <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> fournit les arguments <code class="docutils literal notranslate"><span class="pre">fields</span></code> et <code class="docutils literal notranslate"><span class="pre">exclude</span></code> permettant de spécifier les champs que l’on souhaite sérialiser.</p>
<p>Par défaut, seules les champs qui ne sont pas des relationshisp sont sérialisées (fonctionnalité similaire à celle fournit par <code class="docutils literal notranslate"><span class="pre">SmartRelationshipsMixin</span></code> pour Marshmallow).</p>
<p>Les relations que l’on souhaite voir sérialisées doivent être explicitement déclarées via l’argument <code class="docutils literal notranslate"><span class="pre">fields</span></code>.</p>
<p>L’argument <code class="docutils literal notranslate"><span class="pre">fields</span></code> supporte la « notation à point » permettant de préciser les champs d’un modèle en relation :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">child</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parent.pk&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Les <a class="reference external" href="https://github.com/PnX-SI/Utils-Flask-SQLAlchemy/blob/master/src/utils_flask_sqla/tests/test_serializers.py">tests unitaires</a> fournissent un ensemble d’exemples d’usage du décorateur.</p>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> prenait autrefois en argument les paramètres <code class="docutils literal notranslate"><span class="pre">recursif</span></code> et <code class="docutils literal notranslate"><span class="pre">depth</span></code> qui sont tous les deux obsolètes. Ces derniers ont différents problèmes :</p>
<ul class="simple">
<li><p>récursion infinie (contournée par un hack qui ne résoud pas tous les problèmes et qu’il serait souhaitable de voir disparaitre)</p></li>
<li><p>augmentation non prévue des données sérialisées lors de l’ajout d’une nouvelle relationship</p></li>
<li><p>problème n+1 (voir section dédiée)</p></li>
</ul>
</section>
<section id="cas-des-modeles-geographiques">
<h4>Cas des modèles géographiques<a class="headerlink" href="#cas-des-modeles-geographiques" title="Lien permanent vers cette rubrique"></a></h4>
<p>La bibliothèque maison <a class="reference external" href="https://github.com/PnX-SI/Utils-Flask-SQLAlchemy-Geo">Utils-Flask-SQLAlchemy-Geo</a> fournit des décorateurs supplémentaires pour la sérialisation des modèles contenant des champs géographiques.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.geoserializable</span></code></p>
<p>Décorateur pour les modèles SQLA : Ajoute une méthode as_geofeature qui
retourne un dictionnaire serialisable sous forme de Feature geojson.</p>
<p>Fichier définition modèle</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla_geo.serializers</span> <span class="kn">import</span> <span class="n">geoserializable</span>


<span class="nd">@geoserializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Fichier utilisation modèle</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">as_geofeature</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.shapeserializable</span></code></p>
<p>Décorateur pour les modèles SQLA :</p>
<ul class="simple">
<li><p>Ajoute une méthode <code class="docutils literal notranslate"><span class="pre">as_list</span></code> qui retourne l’objet sous forme de tableau (utilisé pour créer des shapefiles)</p></li>
<li><p>Ajoute une méthode de classe <code class="docutils literal notranslate"><span class="pre">to_shape</span></code> qui crée des shapefiles à partir des données passées en paramètre</p></li>
</ul>
<p>Fichier définition modèle</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla_geo.serializers</span> <span class="kn">import</span> <span class="n">shapeserializable</span>


<span class="nd">@shapeserializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Fichier utilisation modèle :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># utilisation de as_shape()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyShapeserializableClass</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">MyShapeserializableClass</span><span class="o">.</span><span class="n">as_shape</span><span class="p">(</span>
    <span class="n">geom_col</span><span class="o">=</span><span class="s1">&#39;geom_4326&#39;</span><span class="p">,</span>
    <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">dir_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ROOT_DIR</span> <span class="o">/</span> <span class="s1">&#39;backend/static/shapefiles&#39;</span><span class="p">),</span>
    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.utilsgeometry.FionaShapeService</span></code></p>
<p>Classe utilitaire pour créer des shapefiles.</p>
<p>La classe contient 3 méthodes de classe :</p>
</li>
<li><p>FionaShapeService.create_shapes_struct() : crée la structure de 3 shapefiles
(point, ligne, polygone) à partir des colonens et de la geométrie passée
en paramètre</p></li>
<li><p>FionaShapeService.create_feature() : ajoute un enregistrement
aux shapefiles</p></li>
<li><p>FionaShapeService.save_and_zip_shapefiles() : sauvegarde et zip les
shapefiles qui ont au moins un enregistrement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MySQLAModel</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">FionaShapeService</span><span class="o">.</span><span class="n">create_shapes_struct</span><span class="p">(</span>
                <span class="n">db_cols</span><span class="o">=</span><span class="n">db_cols</span><span class="p">,</span>
                <span class="n">srid</span><span class="o">=</span><span class="n">srid</span><span class="p">,</span>
                <span class="n">dir_path</span><span class="o">=</span><span class="n">dir_path</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">col_mapping</span><span class="o">=</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SYNTHESE&#39;</span><span class="p">][</span><span class="s1">&#39;EXPORT_COLUMNS&#39;</span><span class="p">]</span>
        <span class="p">)</span>
<span class="n">FionaShapeService</span><span class="o">.</span><span class="n">create_feature</span><span class="p">(</span><span class="n">row_as_dict</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
        <span class="n">FionaShapeService</span><span class="o">.</span><span class="n">save_and_zip_shapefiles</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="reponses">
<h3>Réponses<a class="headerlink" href="#reponses" title="Lien permanent vers cette rubrique"></a></h3>
<p>Voici quelques conseils sur l’envoi de réponse dans vos routes.</p>
<ul>
<li><p>Privilégier l’envoi du modèle sérialisé (vues de type create/update), ou d’une liste de modèles sérialisés (vues de type list), plutôt que des structures de données non conventionnelles.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>def get_foo(pk):
    foo = Foo.query.get_or_404(pk)
    return jsonify(foo.as_dict(fields=…))

def get_foo(pk):
    foo = Foo.query.get_or_404(pk)
    return FooSchema(only=…).jsonify(foo)

def list_foo():
    q = Foo.query.filter(…)
    return jsonify([foo.as_dict(fields=…) for foo in q.all()])

def list_foo():
    q = Foo.query.filter(…)
    return FooSchema(only=…).jsonify(q.all(), many=True)
</pre></div>
</div>
</li>
<li><p>Pour les listes vides, ne pas renvoyer le code d’erreur 404 mais une liste vide !</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">jsonify</span><span class="p">([])</span>
</pre></div>
</div>
</li>
<li><p>Renvoyer une liste et sa longueur dans une structure de données non conventionnelle est strictement inutile, il est très simple d’accéder à la longueur de la liste en javascript via l’attribut <code class="docutils literal notranslate"><span class="pre">length</span></code>.</p></li>
<li><p>Traitement des erreurs : utiliser <a class="reference external" href="https://werkzeug.palletsprojects.com/en/2.0.x/exceptions/">les exceptions prévues à cet effet</a> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>from werkzeug.exceptions import Forbidden, BadRequest, NotFound

def restricted_action(pk):
    if …:
        raise Forbidden
</pre></div>
</div>
<ul>
<li><p>Penser à utiliser <code class="docutils literal notranslate"><span class="pre">get_or_404</span></code> plutôt que de lancer une exception <code class="docutils literal notranslate"><span class="pre">NotFound</span></code></p></li>
<li><p>Si l’utilisateur n’a pas le droit d’effectuer une action, utiliser l’exception <code class="docutils literal notranslate"><span class="pre">Forbidden</span></code> (code HTTP 403), et non l’exception <code class="docutils literal notranslate"><span class="pre">Unauthorized</span></code> (code HTTP 401), cette dernière étant réservée aux utilisateurs non authentifiés.</p></li>
<li><p>Vérifier la validité des données fournies par l’utilisateur (<code class="docutils literal notranslate"><span class="pre">request.json</span></code> ou <code class="docutils literal notranslate"><span class="pre">request.args</span></code>) et lever une exception <code class="docutils literal notranslate"><span class="pre">BadRequest</span></code> si celles-ci ne sont pas valides (l’utilisateur ne doit pas être en mesure de déclencher une erreur 500 en fournissant une string plutôt qu’un int par exemple !).</p>
<ul class="simple">
<li><p>Marshmallow peut servir à cela :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="k">def</span> <span class="nf">my_route</span><span class="p">():</span>
    <span class="k">class</span> <span class="nc">RequestSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">RequestSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Cela peut être fait avec <em>jsonschema</em> :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">from</span> <span class="n">jsonschema</span> <span class="kn">import</span> <span class="nn">validate</span> <span class="k">as</span> <span class="nn">validate_json</span><span class="o">,</span> <span class="nn">ValidationError</span>

<span class="k">def</span> <span class="nf">my_route</span><span class="p">():</span>
    <span class="n">request_schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;minProperties&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">request_schema</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Pour les réponses vides (exemple : route de type delete), on pourra utiliser le code de retour 204 :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">204</span>
</pre></div>
</div>
<p>Lorsque par exemple une action est traitée mais aucun résultat n’est à renvoyer, inutile d’envoyer une réponse « OK ». C’est l’envoi d’une réponse HTTP avec un code égale à 400 ou supérieur qui entrainera le traitement d’une erreur côté frontend, plutôt que de se fonder sur le contenu d’une réponse non normalisée.</p>
</li>
</ul>
<section id="le-decorateur-json-resp">
<h4>Le décorateur <code class="docutils literal notranslate"><span class="pre">&#64;json_resp</span></code><a class="headerlink" href="#le-decorateur-json-resp" title="Lien permanent vers cette rubrique"></a></h4>
<p>Historiquement, beaucoup de vues sont décorées avec le décorateur <code class="docutils literal notranslate"><span class="pre">&#64;json_resp</span></code>.</p>
<p>Celui-ci apparait aujourd’hui superflu par rapport à l’usage directement de la fonction <code class="docutils literal notranslate"><span class="pre">jsonify</span></code> fournie par Flask.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.json_resp</span></code></p>
<p>Décorateur pour les routes : les données renvoyées par la route sont
automatiquement serialisées en json (ou geojson selon la structure des
données).</p>
<p>S’insère entre le décorateur de route flask et la signature de fonction</p>
<p>Fichier routes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla.response</span> <span class="kn">import</span> <span class="n">json_resp</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myview&#39;</span><span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">}</span>


<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myerrview&#39;</span><span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_err_view</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Not OK&#39;</span><span class="p">},</span> <span class="mi">400</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="probleme-n-1">
<h3>Problème « n+1 »<a class="headerlink" href="#probleme-n-1" title="Lien permanent vers cette rubrique"></a></h3>
<p>Le problème « n+1 » est un anti-pattern courant des routes de type « liste » (par exemple, récupération de la liste des cadres d’acquisition).</p>
<p>En effet, on souhaite par exemple afficher la liste des cadres d’acquisitions, et pour chacun d’entre eux, la liste des jeux de données :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af_list</span> <span class="o">=</span> <span class="n">AcquisitionFramwork</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># with Marshmallow (and SmartRelationshipsMixin)</span>
<span class="k">return</span> <span class="n">AcquisitionFrameworkSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">af_list</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># with @serializable</span>
<span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span> <span class="n">af</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">af</span> <span class="ow">in</span> <span class="n">af_list</span><span class="p">])</span>
</pre></div>
</div>
<p>Ainsi, lors de la sérialisation de chaque AF, on demande à sérialiser l’attribut <code class="docutils literal notranslate"><span class="pre">datasets</span></code>, qui est une relationships vers la liste des DS associés :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AcquisitionFramework</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationships</span><span class="p">(</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Sans précision, la <a class="reference external" href="https://docs.sqlalchemy.org/en/14/orm/loading_relationships.html">stratégie de chargement</a> de la relation <code class="docutils literal notranslate"><span class="pre">datasets</span></code> est <code class="docutils literal notranslate"><span class="pre">select</span></code>, c’est-à-dire que l’accès à l’attribut <code class="docutils literal notranslate"><span class="pre">datasets</span></code> d’un AF provoque une nouvelle requête select afin de récupérer la liste des DS concernés.</p>
<p>Ceci est généralement peu grave lorsque l’on manipule un unique objet, mais dans le cas d’une liste d’objet, cela génère 1+n requêtes SQL : une pour récupérer la liste des AF, puis une lors de la sérialisation de chaque AF pour récupérer les DS de ce dernier.</p>
<p>Cela devient alors un problème de performance notable !</p>
<p>Afin de résoudre ce problème, il nous faut joindre les DS à la requête de récupération des AF.</p>
<p>Pour cela, plusieurs solutions :</p>
<ul>
<li><p>Le spécifier dans la relationship :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AcquisitionFramework</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationships</span><span class="p">(</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Cependant, cette stratégie s’appliquera (sauf contre-ordre) dans tous les cas, même lorsque les DS ne sont pas nécessaires, alourdissant potentiellement certaines requêtes qui n’en ont pas usage.</p>
</li>
<li><p>Le spécifier au moment où la requête est effectuée :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">joinedload</span>

<span class="n">af_list</span> <span class="o">=</span> <span class="n">AcquisitionFramework</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
<p>Il est également possible de joindre les relations d’une relation, par exemple le créateur des jeux de données :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af_list</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">AcquisitionFramework</span><span class="o">.</span><span class="n">query</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span>
        <span class="n">joinedload</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">joinedload</span><span class="p">(</span><span class="s1">&#39;creator&#39;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Afin d’être sûr d’avoir joint toutes les relations nécessaires, il est possible d’utiliser la stratégie <code class="docutils literal notranslate"><span class="pre">raise</span></code> par défaut, ce qui va provoquer le lancement d’une exception lors de l’accès à un attribut non pré-chargé, nous incitant à le joindre également :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">raiseload</span><span class="p">,</span> <span class="n">joinedload</span>

<span class="n">af_list</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">AcquisitionFramework</span><span class="o">.</span><span class="n">query</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span>
        <span class="n">raiseload</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span>
        <span class="n">joinedload</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Pour toutes les requêtes récupérant une liste d’objet, l’utilisation de la stratégie <code class="docutils literal notranslate"><span class="pre">raise</span></code> par défaut est grandement encouragée afin de ne pas tomber dans cet anti-pattern.</p>
<p>La méthode <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> du décorateur <code class="docutils literal notranslate"><span class="pre">&#64;serializable</span></code> accepte l’argument <code class="docutils literal notranslate"><span class="pre">unloaded='raise'</span></code> ou <code class="docutils literal notranslate"><span class="pre">unloaded='warn'</span></code> pour un résultat similaire (ou un simple warning).</p>
<p>L’utilisation de <code class="docutils literal notranslate"><span class="pre">raiseload</span></code>, appartenant au cœur de SQLAlchemy, reste à privilégier.</p>
</section>
<section id="export-des-donnees">
<h3>Export des données<a class="headerlink" href="#export-des-donnees" title="Lien permanent vers cette rubrique"></a></h3>
<p>TODO</p>
</section>
<section id="utilisation-de-la-configuration">
<h3>Utilisation de la configuration<a class="headerlink" href="#utilisation-de-la-configuration" title="Lien permanent vers cette rubrique"></a></h3>
<p>La configuration globale de l’application est controlée par le fichier
<code class="docutils literal notranslate"><span class="pre">config/geonature_config.toml</span></code> qui contient un nombre limité de paramètres.</p>
<p>De nombreux paramètres sont néammoins passés à l’application via un schéma
Marshmallow (voir fichier <code class="docutils literal notranslate"><span class="pre">backend/geonature/utils/config_schema.py</span></code>).</p>
<p>Dans l’application flask, l’ensemble des paramètres de configuration sont
utilisables via le dictionnaire <code class="docutils literal notranslate"><span class="pre">config</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="n">MY_PARAMETER</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;MY_PARAMETER&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Chaque module GeoNature dispose de son propre fichier de configuration,
(<code class="docutils literal notranslate"><span class="pre">module/config/cong_gn_module.toml</span></code>) contrôlé de la même manière par un
schéma Marshmallow (<code class="docutils literal notranslate"><span class="pre">module/config/conf_schema_toml.py</span></code>).</p>
<p>Pour récupérer la configuration du module dans l’application Flask,
il existe deux méthodes:</p>
<p>Dans le fichier <code class="docutils literal notranslate"><span class="pre">blueprint.py</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Methode 1 :</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
<span class="n">MY_MODULE_PARAMETER</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MY_MODULE_NAME&#39;</span><span class="p">][</span><span class="s1">&#39;MY_PARAMETER]</span>
<span class="c1"># ou MY_MODULE_NAME est le nom du module tel qu&#39;il est défini dans le fichier ``manifest.toml`` et la table ``gn_commons.t_modules``</span>

<span class="c1">#Méthode 2 :</span>
<span class="n">MY_MODULE_PARAMETER</span> <span class="o">=</span> <span class="n">blueprint</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MY_MODULE_PARAMETER&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Il peut-être utile de récupérer l’ID du module GeoNature (notamment pour des
questions droits). De la même manière que précédement, à l’interieur d’une
route, on peut récupérer l’ID du module de la manière suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ID_MODULE</span> <span class="o">=</span> <span class="n">blueprint</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ID_MODULE&#39;</span><span class="p">]</span>
<span class="c1"># ou</span>
<span class="n">ID_MODULE</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MODULE_NAME&#39;</span><span class="p">][</span><span class="s1">&#39;ID_MODULE&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Si on souhaite récupérer l’ID du module en dehors du contexte d’une route,
il faut utiliser la méthode suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">get_id_module</span>
<span class="n">ID_MODULE</span> <span class="o">=</span> <span class="n">get_id_module</span><span class="p">(</span><span class="n">current_app</span><span class="p">,</span> <span class="s1">&#39;occtax&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="authentification-et-authorisations">
<h3>Authentification et authorisations<a class="headerlink" href="#authentification-et-authorisations" title="Lien permanent vers cette rubrique"></a></h3>
<section id="restreindre-une-route-aux-utilisateurs-connectes">
<h4>Restreindre une route aux utilisateurs connectés<a class="headerlink" href="#restreindre-une-route-aux-utilisateurs-connectes" title="Lien permanent vers cette rubrique"></a></h4>
<p>Utiliser le décorateur <code class="docutils literal notranslate"><span class="pre">&#64;login_required</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.core.gn_permissions.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">my_protected_route</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="connaitre-lutilisateur-actuellement-connecte">
<h4>Connaitre l’utilisateur actuellement connecté<a class="headerlink" href="#connaitre-lutilisateur-actuellement-connecte" title="Lien permanent vers cette rubrique"></a></h4>
<p>L’utilisateur courant est stocké dans l’espace de nom <code class="docutils literal notranslate"><span class="pre">g</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span>

<span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">)</span>
</pre></div>
</div>
<p>Il s’agit d’une instance de <code class="docutils literal notranslate"><span class="pre">pypnusershub.db.models.User</span></code>.</p>
</section>
<section id="verification-des-droits-des-utilisateurs">
<h4>Vérification des droits des utilisateurs<a class="headerlink" href="#verification-des-droits-des-utilisateurs" title="Lien permanent vers cette rubrique"></a></h4>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">geonature.core.gn_permissions.decorators.check_cruved_scope</span></code></p>
<p>Décorateur pour les routes : Vérifie les droits de l’utilisateur à effectuer
une action sur la donnée et le redirige en cas de niveau insuffisant ou
d’informations de session erronées</p>
<p>params :</p>
<ul class="simple">
<li><p>action &lt;str:[“C”,”R”,”U”,”V”,”E”,”D”]&gt; type d’action effectuée par la route
(Create, Read, Update, Validate, Export, Delete)</p></li>
<li><p>get_role &lt;bool:False&gt; : si True, ajoute l’id utilisateur aux kwargs de la vue</p></li>
<li><p>module_code: &lt;str:None&gt; : Code du module (gn_commons.t_modules) sur lequel on
veut récupérer le CRUVED. Si ce paramètre n’est pas passé, on vérifie le
CRUVED de GeoNature</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">geonature.core.gn_permissions.tools</span> <span class="kn">import</span> <span class="n">get_or_fetch_user_cruved</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla.response</span> <span class="kn">import</span> <span class="n">json_resp</span>
<span class="kn">from</span> <span class="nn">geonature.core.gn_permissions</span> <span class="kn">import</span> <span class="n">decorators</span> <span class="k">as</span> <span class="n">permissions</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/mysensibleview&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@permissions</span><span class="o">.</span><span class="n">check_cruved_scope</span><span class="p">(</span>
        <span class="s1">&#39;R&#39;</span><span class="p">,</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="n">module_code</span><span class="o">=</span><span class="s2">&quot;OCCTAX&quot;</span>
<span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_sensible_view</span><span class="p">(</span><span class="n">info_role</span><span class="p">):</span>
    <span class="c1"># Récupérer l&#39;id de l&#39;utilisateur qui demande la route</span>
    <span class="n">id_role</span> <span class="o">=</span> <span class="n">info_role</span><span class="o">.</span><span class="n">id_role</span>
    <span class="c1"># Récupérer la portée autorisée à l&#39;utilisateur pour l&#39;action &#39;R&#39; (read)</span>
    <span class="n">read_scope</span> <span class="o">=</span> <span class="n">info_role</span><span class="o">.</span><span class="n">value_filter</span>
    <span class="c1">#récupérer le CRUVED complet de l&#39;utilisateur courant</span>
    <span class="n">user_cruved</span> <span class="o">=</span> <span class="n">get_or_fetch_user_cruved</span><span class="p">(</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="n">id_role</span><span class="o">=</span><span class="n">info_role</span><span class="o">.</span><span class="n">id_role</span><span class="p">,</span>
            <span class="n">module_code</span><span class="o">=</span><span class="n">MY_MODULE_CODE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;id_role = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">info_role</span><span class="o">.</span><span class="n">id_role</span><span class="p">)}</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">geonature.core.gn_permissions.tools.cruved_scope_for_user_in_module</span></code></p>
<ul class="simple">
<li><p>Fonction qui retourne le CRUVED d’un utilisateur pour un module et/ou
un objet donné.</p></li>
<li><p>Si aucun CRUVED n’est défini pour le module, c’est celui de GeoNature qui
est retourné, sinon 0.</p></li>
<li><p>Le CRUVED du module enfant surcharge toujours celui du module parent.</p></li>
<li><p>Le CRUVED sur les objets n’est pas hérité du module parent.</p></li>
</ul>
<p>params :</p>
<ul class="simple">
<li><p>id_role &lt;integer:None&gt;</p></li>
<li><p>module_code &lt;str:None&gt; : code du module sur lequel on veut avoir le CRUVED</p></li>
<li><p>object_code &lt;str:”ALL”&gt; : code de l’objet sur lequel on veut avoir le CRUVED</p></li>
<li><p>get_id &lt;boolean: False&gt; : retourne l’id_filter et non le code_filter si True</p></li>
</ul>
<p>Valeur retournée : tuple</p>
<p>A l’indice 0 du tuple: &lt;dict{str:str}&gt; ou &lt;dict{str:int}&gt;, boolean)
{“C”: “1”, “R”:”2”, “U”: “1”, “V”:”2”, “E”:”3”, “D”: “3”} ou
{“C”: 2, “R”:3, “U”: 4, “V”:1, “E”:2, “D”: 2} si <code class="docutils literal notranslate"><span class="pre">get_id=True</span></code></p>
<p>A l’indice 1 du tuple: un booléen spécifiant si le CRUVED est hérité depuis
un module parent ou non.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pypnusershub.db.tools</span> <span class="kn">import</span> <span class="n">cruved_for_user_in_app</span>

<span class="c1"># récupérer le CRUVED de l&#39;utilisateur 1 dans le module OCCTAX</span>
<span class="n">cruved</span><span class="p">,</span> <span class="n">herited</span> <span class="o">=</span> <span class="n">cruved_scope_for_user_in_module</span><span class="p">(</span>
        <span class="n">id_role</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">module_code</span><span class="o">=</span><span class="s1">&#39;OCCTAX</span>
<span class="p">)</span>
<span class="c1"># récupérer le CRUVED de l&#39;utilisateur 1 sur GeoNature</span>
<span class="n">cruved</span><span class="p">,</span> <span class="n">herited</span> <span class="o">=</span> <span class="n">cruved_scope_for_user_in_module</span><span class="p">(</span><span class="n">id_role</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>
<section id="developpement-frontend">
<h2>Développement Frontend<a class="headerlink" href="#developpement-frontend" title="Lien permanent vers cette rubrique"></a></h2>
<section id="bonnes-pratiques">
<h3>Bonnes pratiques<a class="headerlink" href="#bonnes-pratiques" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p>Chaque gn_module de GeoNature doit être un module Angular indépendant <a class="reference external" href="https://angular.io/guide/ngmodule">https://angular.io/guide/ngmodule</a>.</p></li>
<li><p>Ce gn_module peut s’appuyer sur une série de composants génériques intégrés dans le module GN2CommonModule et décrit ci-dessous</p></li>
</ul>
</section>
<section id="les-composants-generiques">
<h3>Les composants génériques<a class="headerlink" href="#les-composants-generiques" title="Lien permanent vers cette rubrique"></a></h3>
<p>Un ensemble de composants décrits ci-dessous sont intégrés dans le coeur de GeoNature et permettent aux développeurs de simplifier la mise en place de formulaires ou de bloc cartographiques.</p>
<p>Voir la <a class="reference external" href="http://pnx-si.github.io/GeoNature/frontend/modules/GN2CommonModule.html">DOCUMENTATION COMPLETE</a> sur les composants génériques.</p>
<p>NB : les composants de type « formulaire » (balise <cite>input</cite> ou <cite>select</cite>) partagent une logique commune et ont des <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> et des <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> communs, décrits ci-dessous. (voir <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/frontend/src/app/GN2CommonModule/form/genericForm.component.ts">https://github.com/PnX-SI/GeoNature/blob/master/frontend/src/app/GN2CommonModule/form/genericForm.component.ts</a>).</p>
<p>Une documentation complète des composants génériques est
<a class="reference external" href="http://pnx-si.github.io/GeoNature/frontend/modules/GN2CommonModule.html">disponible ici</a></p>
<p>NB : les composants de type « formulaire » (balise <cite>input</cite> ou <cite>select</cite>) partagent
une logique commune et ont des <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> et des <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> communs, décrits
ci-dessous.
(voir <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/frontend/src/app/GN2CommonModule/form/genericForm.component.ts">https://github.com/PnX-SI/GeoNature/blob/master/frontend/src/app/GN2CommonModule/form/genericForm.component.ts</a>).</p>
<ul>
<li><p>Inputs</p>
<ul class="simple">
<li><p>L’input <code class="docutils literal notranslate"><span class="pre">parentFormControl</span></code> de type <code class="docutils literal notranslate"><span class="pre">FormControl</span></code> (<a class="reference external" href="https://angular.io/api/forms/FormControl">https://angular.io/api/forms/FormControl</a>) permet de contrôler la logique et les valeurs du formulaire depuis l’extérieur du composant. Cet input est <strong>obligatoire</strong> pour le fonctionnement du composant.</p></li>
<li><p>L’input <code class="docutils literal notranslate"><span class="pre">label</span></code> (string) permet d’afficher un label au dessus de l’input.</p></li>
<li><p>L’input <code class="docutils literal notranslate"><span class="pre">displayAll</span></code> (boolean, défaut = false) permet d’ajouter un item “tous” sur les inputs de type select (Exemple : pour sélectionner tous les jeux de données de la liste)</p></li>
<li><p>L’input <code class="docutils literal notranslate"><span class="pre">multiSelect</span></code> (boolean, défaut = false) permet de passer les composants de type select en « multiselect » (sélection multiple sur une liste déroulante). Le parentFormControl devient par conséquent un tableau</p></li>
<li><p>L’input <code class="docutils literal notranslate"><span class="pre">searchBar</span></code> (boolean, défaut = false) permet de rajouter une barre de recherche sur les composants multiselect</p></li>
<li><p>L’input <code class="docutils literal notranslate"><span class="pre">disabled</span></code> (boolean) permet de rendre le composant non-saisissable</p></li>
<li><p>L’input <code class="docutils literal notranslate"><span class="pre">debounceTime</span></code> définit une durée en ms après laquelle les évenements <code class="docutils literal notranslate"><span class="pre">onChange</span></code> et <code class="docutils literal notranslate"><span class="pre">onDelete</span></code> sont déclenchés suite à un changement d’un formulaire. (Par défault à 0)</p></li>
</ul>
</li>
<li><p>Outputs</p>
<p>Plusieurs <code class="docutils literal notranslate"><span class="pre">Output</span></code> communs à ses composants permettent d’émettre des événements liés aux formulaires.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">onChange</span></code> : événement émit à chaque fois qu’un changement est effectué sur le composant. Renvoie la valeur fraiche de l’input.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onDelete</span></code> : événement émit chaque fois que le champ du formulaire est supprimé. Renvoie un évenement vide.</p></li>
</ul>
</li>
</ul>
<p>Ces composants peuvent être considérés comme des « dump components » ou
« presentation components », puisque que la logique de contrôle est déporté
au composant parent qui l’accueil
(<a class="reference external" href="https://blog.angular-university.io/angular-2-smart-components-vs-presentation-components-whats-the-difference-when-to-use-each-and-why/">https://blog.angular-university.io/angular-2-smart-components-vs-presentation-components-whats-the-difference-when-to-use-each-and-why/</a>)</p>
<p>Un ensemble de composants permettant de simplifier l’affichage des cartographies
Leaflet sont disponibles. Notamment un composant « map-list » permettant de
connecter une carte avec une liste d’objets décrits en détail ci dessous.</p>
<section id="maplistcomponent">
<h4>MapListComponent<a class="headerlink" href="#maplistcomponent" title="Lien permanent vers cette rubrique"></a></h4>
<p>Le composant MapList fournit une carte pouvant être synchronisée
avec une liste. La liste, pouvant être spécifique à chaque module,
elle n’est pas intégrée dans le composant et est laissée à la
responsabilité du développeur. Le service <code class="docutils literal notranslate"><span class="pre">MapListService</span></code> offre
cependant des fonctions permettant facilement de synchroniser
les deux éléments.</p>
<p>Fonctionnalité et comportement offert par le composant et le
service :</p>
<ul>
<li><p>Charger les données</p>
<p>Le service expose la fonction <code class="docutils literal notranslate"><span class="pre">getData(apiEndPoint,</span> <span class="pre">params?)</span></code>
permettant de charger les données pour la carte et la liste.
Cette fonction doit être utilisée dans le composant qui utilise
le composant <code class="docutils literal notranslate"><span class="pre">MapListComponent</span></code>. Elle se charge de faire
appel à l’API passée en paramètre et de rendre les données
disponibles au service.</p>
<p>Le deuxième paramètre <code class="docutils literal notranslate"><span class="pre">params</span></code> est un tableau de paramètre(s)
(facultatif). Il permet de filtrer les données sur n’importe
quelle propriété du GeoJson, et également de gérer
la pagination.</p>
<p>Exemple : afficher les 10 premiers relevés du cd_nom 212 :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapListService</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="s1">&#39;occtax/releve&#39;</span><span class="p">,</span>
<span class="p">[{</span><span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="s1">&#39;},</span>
<span class="p">{</span><span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="s1">&#39;cd_nom&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">212</span><span class="s1">&#39;}])</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/contrib/occtax/frontend/app/occtax-map-list/occtax-map-list.component.ts#L99/">Exemple dans le module OccTax</a></p>
<p>L’API doit nécessairement renvoyer un objet comportant un
GeoJson. La structure du l’objet doit être la suivante :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">nombre</span> <span class="n">d</span><span class="s1">&#39;élément total,</span>
<span class="s1">&#39;total_filtered&#39;</span><span class="p">:</span> <span class="n">nombre</span> <span class="n">d</span><span class="s1">&#39;élément filtré,</span>
<span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">numéro</span> <span class="n">de</span> <span class="n">page</span> <span class="n">de</span> <span class="n">la</span> <span class="n">liste</span><span class="p">,</span>
<span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">limite</span> <span class="n">d</span><span class="s1">&#39;élément renvoyé,</span>
<span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="n">le</span> <span class="n">GeoJson</span>
</pre></div>
</div>
<p>Pour une liste simple sans pagination, seule la propriété “items”
est obligatoire.</p>
</li>
<li><p>Rafraîchir les données</p>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">refreshData(apiEndPoint,</span> <span class="pre">method,</span> <span class="pre">params?)</span></code> permet de raffrachir les données en fonction de filtres personnalisés.
Les paramètres <code class="docutils literal notranslate"><span class="pre">apiEndPoint</span></code> et <code class="docutils literal notranslate"><span class="pre">params</span></code> sont les mêmes que pour la fonction <code class="docutils literal notranslate"><span class="pre">getData</span></code>. Le paramètre <code class="docutils literal notranslate"><span class="pre">method</span></code> permet lui de chosir si on ajoute - <code class="docutils literal notranslate"><span class="pre">append</span></code>- , ou si on initialise (ou remplace) -<code class="docutils literal notranslate"><span class="pre">set</span></code>- un filtre.</p>
<p>Exemple 1 : Pour filtrer sur l’observateur 1, puis ajouter un filtre sur l’observateur 2 :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapListService</span><span class="o">.</span><span class="n">refreshData</span><span class="p">(</span><span class="s1">&#39;occtax/relevé&#39;</span><span class="p">,</span> <span class="s1">&#39;append, [{&#39;</span><span class="n">param</span><span class="s1">&#39;: &#39;</span><span class="n">observers</span><span class="s1">&#39;, &#39;</span><span class="n">value</span><span class="s1">&#39;: 1&#39;</span><span class="p">}])</span>
</pre></div>
</div>
<p>puis :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">refreshData</span><span class="p">(</span><span class="s1">&#39;occtax/relevé&#39;</span><span class="p">,</span> <span class="s1">&#39;append, [{&#39;</span><span class="n">param</span><span class="s1">&#39;: &#39;</span><span class="n">observers</span><span class="s1">&#39;, &#39;</span><span class="n">value</span><span class="s1">&#39;: 2&#39;</span><span class="p">}])</span>
</pre></div>
</div>
<p>Exemple 2: pour filtrer sur le cd_nom 212, supprimer ce filtre et filtrer sur  le cd_nom 214</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapListService</span><span class="o">.</span><span class="n">refreshData</span><span class="p">(</span><span class="s1">&#39;occtax/relevé&#39;</span><span class="p">,</span> <span class="s1">&#39;set, [{&#39;</span><span class="n">param</span><span class="s1">&#39;: &#39;</span><span class="n">cd_nom</span><span class="s1">&#39;, &#39;</span><span class="n">value</span><span class="s1">&#39;: 1&#39;</span><span class="p">}])</span>
</pre></div>
</div>
<p>puis :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapListService</span><span class="o">.</span><span class="n">refreshData</span><span class="p">(</span><span class="s1">&#39;occtax/relevé&#39;</span><span class="p">,</span> <span class="s1">&#39;set, [{&#39;</span><span class="n">param</span><span class="s1">&#39;: &#39;</span><span class="n">cd_nom</span><span class="s1">&#39;, &#39;</span><span class="n">value</span><span class="s1">&#39;: 2&#39;</span><span class="p">}])</span>
</pre></div>
</div>
</li>
<li><p>Gestion des évenements :</p>
<ul class="simple">
<li><p>Au clic sur un marker de la carte, le service <code class="docutils literal notranslate"><span class="pre">MapListService</span></code> expose la propriété <code class="docutils literal notranslate"><span class="pre">selectedRow</span></code> qui est un tableau contenant l’id du marker sélectionné. Il est ainsi possible de surligner l’élément séléctionné dans le liste.</p></li>
<li><p>Au clic sur une ligne du tableau, utiliser la fonction <code class="docutils literal notranslate"><span class="pre">MapListService.onRowSelected(id)</span></code> (id étant l’id utilisé dans le GeoJson) qui permet de zoomer sur le point séléctionner et de changer la couleur de celui-ci.</p></li>
</ul>
</li>
</ul>
<p>Le service contient également deux propriétés publiques <code class="docutils literal notranslate"><span class="pre">geoJsonData</span></code> (le geojson renvoyé par l’API) et <code class="docutils literal notranslate"><span class="pre">tableData</span></code> (le tableau de features du Geojson) qui sont respectivement passées à la carte et à la liste. Ces deux propriétés sont utilisables pour interagir (ajouter, supprimer) avec les données de la carte et de la liste.</p>
<ul>
<li><p>Selector : <code class="docutils literal notranslate"><span class="pre">pnx-map-list</span></code></p></li>
<li><p>Inputs :</p>
<dl class="field-list">
<dt class="field-odd"><code class="docutils literal notranslate"><span class="pre">idName</span></code></dt>
<dd class="field-odd"><p>Libellé de l’id du geojson (id_releve, id)</p>
<p>Type: <code class="docutils literal notranslate"><span class="pre">string</span></code></p>
</dd>
<dt class="field-even"><code class="docutils literal notranslate"><span class="pre">height</span></code></dt>
<dd class="field-even"><p>Taille de l’affichage de la carte Leaflet</p>
<p>Type: <code class="docutils literal notranslate"><span class="pre">string</span></code></p>
</dd>
</dl>
</li>
</ul>
<p>Exemple d’utilisation avec une liste simple :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">pnx</span><span class="o">-</span><span class="nb">map</span><span class="o">-</span><span class="nb">list</span>
        <span class="n">idName</span><span class="o">=</span><span class="s2">&quot;id_releve_occtax&quot;</span>
        <span class="n">height</span><span class="o">=</span><span class="s2">&quot;80vh&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">pnx</span><span class="o">-</span><span class="nb">map</span><span class="o">-</span><span class="nb">list</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">table</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">tr</span> <span class="n">ngFor</span><span class="o">=</span><span class="s2">&quot;let row of mapListService.tableData&quot;</span> <span class="p">[</span><span class="n">ngClass</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot; {&#39;selected&#39;: mapListService.selectedRow[0]} == row.id &quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="p">(</span><span class="n">click</span><span class="p">)</span><span class="o">=</span><span class="s2">&quot;mapListService.onRowSelect(row.id)&quot;</span><span class="o">&gt;</span> <span class="n">Zoom</span> <span class="n">on</span> <span class="nb">map</span> <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="o">&gt;</span> <span class="p">{{</span><span class="n">row</span><span class="o">.</span><span class="n">observers</span><span class="p">}}</span> <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="o">&gt;</span> <span class="p">{{</span><span class="n">row</span><span class="o">.</span><span class="n">date</span><span class="p">}}</span> <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="test-end-to-end">
<h3>Test end to end<a class="headerlink" href="#test-end-to-end" title="Lien permanent vers cette rubrique"></a></h3>
<p>Pour toute PR ou nouvelle fonctionnalité il est demandé d’écrire des tests.
Pour les test e2e, la librairie Cypress est utilisé.
Des exemples de tests peuvent être trouvé ici : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/tree/develop/frontend/cypress/integration">https://github.com/PnX-SI/GeoNature/tree/develop/frontend/cypress/integration</a>
Les tests sont joués automatiquement sur Github-action lors de commit et PR sur la branch develop et master.
Pour lancer les tests sur sa machine locale, utilisez la commande <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">run</span> <span class="pre">e2e</span> <span class="pre">&amp;&amp;</span> <span class="pre">npm</span> <span class="pre">run</span> <span class="pre">e2e:coverage</span></code>. Celle-ci lance le serveur de frontend, joue les tests cypress et contrôle la couverture de test. Cette dernière est disponible dans le repertoire <cite>frontend/coverage</cite>.</p>
</section>
<section id="id3">
<h3>Test end to end<a class="headerlink" href="#id3" title="Lien permanent vers cette rubrique"></a></h3>
<p>Pour toute PR ou nouvelle fonctionnalité il est demandé d’écrire des tests.
Pour les test e2e, la librairie Cypress est utilisé.
Des exemples de tests peuvent être trouvé ici : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/tree/develop/frontend/cypress/integration">https://github.com/PnX-SI/GeoNature/tree/develop/frontend/cypress/integration</a>
Les tests sont joués automatiquement sur Github-action lors de commit et PR sur la branch develop et master.
Pour lancer les tests sur sa machine locale, utilisez la commande <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">run</span> <span class="pre">e2e</span> <span class="pre">&amp;&amp;</span> <span class="pre">npm</span> <span class="pre">run</span> <span class="pre">e2e:coverage</span></code>. Celle-ci lance le serveur de frontend, joue les tests cypress et contrôle la couverture de test. Cette dernière est disponible dans le repertoire <cite>frontend/coverage</cite>.</p>
<ul class="simple">
<li><p>dans les templates : <code class="docutils literal notranslate"><span class="pre">[valueFieldName]=&quot;'area_code'</span></code> dans les templates</p></li>
<li><p>dans les config (js, ts ou json) (attention à la casse) : <code class="docutils literal notranslate"><span class="pre">&quot;value_field_name&quot;:</span> <span class="pre">&quot;area_code&quot;</span></code></p></li>
<li><p>dans le module Monitoring, ajouter aussi <code class="docutils literal notranslate"><span class="pre">&quot;type_util&quot;:</span> <span class="pre">&quot;area&quot;</span></code></p></li>
</ul>
</section>
</section>
<section id="outils-d-aide-a-la-qualite-du-code">
<h2>Outils d’aide à la qualité du code<a class="headerlink" href="#outils-d-aide-a-la-qualite-du-code" title="Lien permanent vers cette rubrique"></a></h2>
<p>Des outils d’amélioration du code pour les développeurs peuvent être utilisés :
flake8, pylint, pytest, coverage.</p>
<p>La documentation peut être générée avec Sphinx.</p>
<p>Les fichiers de configuration de ces outils se trouvent à la racine du projet :</p>
<ul class="simple">
<li><p>.pylint</p></li>
</ul>
<p>Un fichier <code class="docutils literal notranslate"><span class="pre">.editorconfig</span></code> permettant de définir le comportement de
votre éditeur de code est également disponible à la racine du projet.</p>
<section id="sphinx">
<h3>Sphinx<a class="headerlink" href="#sphinx" title="Lien permanent vers cette rubrique"></a></h3>
<p>Sphinx est un générateur de documentation.</p>
<p>Pour générer la documentation HTML, se placer dans le répertoire <code class="docutils literal notranslate"><span class="pre">docs</span></code>
et modifier les fichiers .rst:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">docs</span>
<span class="n">make</span> <span class="n">html</span>
</pre></div>
</div>
</section>
<section id="pylint">
<h3>Pylint<a class="headerlink" href="#pylint" title="Lien permanent vers cette rubrique"></a></h3>
<p>Pylint fait la même chose que Flake8 mais il est plus complet, plus
configurable mais aussi plus exigeant.</p>
<p>Pour inspecter le répertoire <code class="docutils literal notranslate"><span class="pre">geonature</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">backend</span>
<span class="n">pylint</span> <span class="n">geonature</span>
</pre></div>
</div>
</section>
<section id="tslint">
<h3>tslint<a class="headerlink" href="#tslint" title="Lien permanent vers cette rubrique"></a></h3>
<p>tslint fait la même chose que pylint mais pour la partie frontend en
typescript:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">frontend</span>
<span class="n">npm</span> <span class="n">run</span> <span class="n">lint</span>
</pre></div>
</div>
</section>
</section>
<section id="tests-backend">
<h2>Tests backend<a class="headerlink" href="#tests-backend" title="Lien permanent vers cette rubrique"></a></h2>
<p>Cette documentation a pour objectif d’expliquer comment écrire des tests pour
le backend de GeoNature.</p>
<p>Un test se décompose en général en 3 étapes :</p>
<ul class="simple">
<li><p><strong>Arrange</strong> : prépare tous les éléments avant l’exécution de la portion de
code à tester (en général une fonction)</p></li>
<li><p><strong>Act</strong> : exécute cette portion de code</p></li>
<li><p><strong>Assert</strong> : vérifie que l’exécution s’est bien déroulée</p></li>
</ul>
<p>Il est toujours utile de distinguer dans le code ces 3 étapes en ajoutant un
commentaire ou une séparation entre elles.</p>
<p>Enfin un test doit être concis, il vaut mieux écrire plusieurs tests pour
tester différentes configurations plutôt qu’un seul les testant toutes d’un
coup. Cela permet d’identifier plus précisément le test qui n’a pas fonctionné.</p>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Lien permanent vers cette rubrique"></a></h3>
<p>Comme spécifié dans la partie Développement, la librairie Python PyTest est
utilisée pour rédiger des tests. Elle permet de :</p>
<ul class="simple">
<li><p>disposer d’un framework de redaction de tests en se basant notamment sur
l’instruction <code class="docutils literal notranslate"><span class="pre">assert</span></code></p></li>
<li><p>écrire des objets ou des portions de code réutilisables : les <code class="docutils literal notranslate"><span class="pre">fixtures</span></code></p></li>
<li><p>lancer un même test avec des configurations différentes</p></li>
<li><p>faire de nombreuses autres choses décrites dans la
<a class="reference external" href="https://docs.pytest.org/">documentation PyTest</a></p></li>
</ul>
</section>
<section id="utilisation">
<h3>Utilisation<a class="headerlink" href="#utilisation" title="Lien permanent vers cette rubrique"></a></h3>
<p>Les tests sont des fonctions pouvant être regroupées dans des classes. La
nomenclature est la suivante :</p>
<ul class="simple">
<li><p>Les tests doivent être situées dans un dossier nommé tests (dans
GeoNature, ils sont situés dans <code class="docutils literal notranslate"><span class="pre">backend/geonature/tests</span></code>)</p></li>
<li><p>Le nom de chaque fichier Python contenant des tests doit commencer par
<code class="docutils literal notranslate"><span class="pre">test_</span></code></p></li>
<li><p>Chaque classe comprenant des tests doit commencer par <code class="docutils literal notranslate"><span class="pre">Test</span></code> (pas de
underscore car la norme PEP8 impose un nom de classe en CamelCase)</p></li>
<li><p>Chaque nom de test (donc de fonction) doit commencer par <code class="docutils literal notranslate"><span class="pre">test_</span></code> pour
pouvoir être détecté automatiquement par PyTest</p></li>
</ul>
</section>
<section id="fixtures">
<h3>Fixtures<a class="headerlink" href="#fixtures" title="Lien permanent vers cette rubrique"></a></h3>
<p>Les fixtures de PyTest peuvent permettre de nombreuses choses comme expliqué
dans la documentation PyTest sur <a class="reference external" href="https://docs.pytest.org/explanation/fixtures.html#about-fixtures">les fixtures</a>.</p>
<p>Dans GeoNature elles sont, en général, utilisées pour définir des objets
réutilisables comme des utilisateurs en base de données pour tester les droits, des observations fictives de taxon pour tester des routes de la synthèse ou
encore des éléments non présents en base pour tester que le code voulant les
récupérer ne plante pas etc.</p>
<p>Elles sont aussi utilisées pour fournir un contexte à un test. Par exemple, la
fixture <code class="docutils literal notranslate"><span class="pre">temporary_transaction</span></code> permet de ne pas sauvegarder ce qui sera
inséré/supprimé/modifié dans la base de données pendant le test.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>La plupart des fixtures sont rassemblées dans
<code class="docutils literal notranslate"><span class="pre">backend/geonature/tests/fixtures.py</span></code>, il est important de regarder
lesquelles y sont définies avant d’en écrire d’autres !</p>
</div>
<p>Enfin, les fixtures peuvent aussi être définies directement dans le fichier
Python du test. Elles sont définies comme suit :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obligatoire pour accéder au décorateur</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># Définit une fixture qui renverra 2</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_fixture</span><span class="p">():</span>
  <span class="k">return</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Et s’utilisent comme suit :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># On passe directement la fixture en argument du test. Il est</span>
<span class="c1"># nécessaire de l&#39;importer si elle n&#39;est pas définie dans le même fichier</span>
<span class="c1"># Ce test n&#39;est pas dans une classe (donc pas de self)</span>
<span class="k">def</span> <span class="nf">test_ma_fonction_a_tester</span><span class="p">(</span><span class="n">my_fixture</span><span class="p">):</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">my_fixture</span>

  <span class="c1"># On vérifie que la fixture retourne la bonne valeur</span>
  <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Il est aussi possible de définir un <code class="docutils literal notranslate"><span class="pre">scope</span></code> d’une fixture comme ceci :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Définit une fixture qui renverra 2 mais qui sera exécutée qu&#39;une</span>
<span class="c1"># seule fois par classe (une classe regroupe plusieurs tests) au</span>
<span class="c1"># lieu d&#39;une fois par test. Il est possible aussi de définir ce</span>
<span class="c1"># scope au module ou à la function</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_fixture</span><span class="p">():</span>
  <span class="k">return</span> <span class="mi">2</span>
</pre></div>
</div>
</section>
<section id="exemple">
<h3>Exemple<a class="headerlink" href="#exemple" title="Lien permanent vers cette rubrique"></a></h3>
<p>Voici un exemple de test qui a été fait dans GeoNature</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_consistancy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">synthese_record</span> <span class="o">=</span> <span class="n">Synthese</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;gn_profiles.get_consistancy_data&quot;</span><span class="p">,</span>
                <span class="n">id_synthese</span><span class="o">=</span><span class="n">synthese_record</span><span class="o">.</span><span class="n">id_synthese</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</pre></div>
</div>
<p>Ce test est situé dans une classe (le <code class="docutils literal notranslate"><span class="pre">self</span></code> est donc obligatoire). Ce test
vérifie que la route <code class="docutils literal notranslate"><span class="pre">gn_profiles.get_consistancy_data</span></code> fonctionne bien avec
un <code class="docutils literal notranslate"><span class="pre">id_synthese</span></code> pris dans la base de données. Le <code class="docutils literal notranslate"><span class="pre">assert</span></code> est directement
interprété par PyTest et le test sera en erreur si la condition n’est pas
respectée. Il est possible d’écrire plusieurs <code class="docutils literal notranslate"><span class="pre">assert</span></code> pour un même test !</p>
<p>Enfin, une fixture a été utilisée au niveau de la classe pour rendre accessible
l’attribut <code class="docutils literal notranslate"><span class="pre">client</span></code> de la classe, utile pour faire des requêtes http
notamment.</p>
</section>
<section id="dans-github">
<h3>Dans GitHub<a class="headerlink" href="#dans-github" title="Lien permanent vers cette rubrique"></a></h3>
<p>Dans le dépôt de GeoNature sur GitHub, tous ces tests sont exécutés
automatiquement pour chaque commit d’une pull request grâce à PyTest et à
GitHub Actions. Ils permettent donc de vérifier que les modifications apportées
par les développeurs ne changent pas le statut des tests et permettent donc aux
mainteneurs du projet de disposer d’une meilleure confiance dans la pull
request. Un coverage est aussi exécuté pour s’assurer que les nouveaux
développements sont bien testés.</p>
</section>
<section id="coverage">
<h3>Coverage<a class="headerlink" href="#coverage" title="Lien permanent vers cette rubrique"></a></h3>
<p>Le coverage est un système permettant de quantifier les lignes de code
exécutées par le test. Exemple rapide :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Définition d&#39;une fonction quelconque</span>
<span class="k">def</span> <span class="nf">ma_fonction_a_tester</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;blablabla&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;blabla&quot;</span>

<span class="c1"># Définition d&#39;un possible test associé</span>
<span class="k">def</span> <span class="nf">test_ma_fonction_a_tester</span><span class="p">():</span>
    <span class="c1"># Arrange</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Act</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">ma_fonction_a_tester</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;blablabla&quot;</span>
</pre></div>
</div>
<p>Dans cet exemple, un seul test a été écrit où <code class="docutils literal notranslate"><span class="pre">verbose</span> <span class="pre">=</span> <span class="pre">True</span></code> donc la
ligne <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">&quot;blabla&quot;</span></code> ne sera jamais exécutée par un test. Donc sur les 3
lignes de la fonction, seules 67% des lignes ont été exécutées donc le
coverage serait d’environ (le calcul est plus complexe) 67%. Il faudrait
donc écrire un nouveau test avec <code class="docutils literal notranslate"><span class="pre">verbose</span> <span class="pre">=</span> <span class="pre">False</span></code> dans <code class="docutils literal notranslate"><span class="pre">Arrange</span></code> pour
obtenir 100% de coverage sur la fonction <code class="docutils literal notranslate"><span class="pre">ma_fonction_a_tester()</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Un coverage de 100% ne garantit pas un code sans bug ! Il permet plutôt
d’être plus confiant dans la modification/refactorisation de lignes de code et dans le développement de nouvelles fonctionnalités.</p>
</div>
</section>
<section id="dans-vscode">
<h3>Dans VSCode<a class="headerlink" href="#dans-vscode" title="Lien permanent vers cette rubrique"></a></h3>
<p>Il est possible d’installer <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=ms-python.python">l’extension Python</a> pour facilement lancer et
debugger un ou plusieurs tests directement depuis VSCode. Il suffit juste de
changer le fichier <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> dans le dossier <code class="docutils literal notranslate"><span class="pre">.vscode</span></code> de votre
projet avec le code suivant pour qu’il soit compatible avec GeoNature :</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;python.testing.pytestArgs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;/chemin/vers/geonature/backend/geonature/tests&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;python.testing.unittestEnabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;python.testing.pytestEnabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="executer-un-ou-plusieurs-test-s-en-ligne-de-commande">
<h3>Exécuter un ou plusieurs test(s) en ligne de commande<a class="headerlink" href="#executer-un-ou-plusieurs-test-s-en-ligne-de-commande" title="Lien permanent vers cette rubrique"></a></h3>
<p>Pour exécuter les tests de GeoNature placez vous à la racine du dossier où est
installé GeoNature et exécutez la commande suivante :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span>
</pre></div>
</div>
<p>Assurez vous d’avoir bien installé les librairies de développement avant
(en étant toujours placé à la racine de l’installation de GeoNature) :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">e</span> <span class="o">.</span><span class="p">[</span><span class="n">tests</span><span class="p">]</span>
</pre></div>
</div>
<p>Pour exécuter un seul test l’option <code class="docutils literal notranslate"><span class="pre">-k</span></code> est très utile :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span> <span class="o">-</span><span class="n">k</span> <span class="s1">&#39;test_uuid_report_with_dataset_id&#39;</span>
</pre></div>
</div>
<p>Ici, elle exécutera uniquement le test <code class="docutils literal notranslate"><span class="pre">test_uuid_report_with_dataset_id</span></code> (du
ficher <code class="docutils literal notranslate"><span class="pre">test_gn_meta.py</span></code>).</p>
<p>Enfin, pour générer le coverage en même temps que les tests :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span> <span class="o">--</span><span class="n">cov</span> <span class="o">--</span><span class="n">cov</span><span class="o">-</span><span class="n">report</span> <span class="n">xml</span>
</pre></div>
</div>
<p>Le format <code class="docutils literal notranslate"><span class="pre">xml</span></code> est interprété par l’extension VSCode <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=ryanluker.vscode-coverage-gutters">Coverage Gutters</a> qui fournie directement dans le code les lignes couvertes et celles non parcourues par le test.</p>
<p>Si vous souhaitez voir le coverage directement depuis le navigateur, il est
possible de générer le coverage au format html en remplaçant <code class="docutils literal notranslate"><span class="pre">xml</span></code> par
<code class="docutils literal notranslate"><span class="pre">html</span></code>.</p>
</section>
</section>
<section id="tests-frontend">
<h2>Tests frontend<a class="headerlink" href="#tests-frontend" title="Lien permanent vers cette rubrique"></a></h2>
<p>Cette documentation a pour objectif d’expliquer comment écrire des tests pour
le frontend de GeoNature.</p>
<p>L’écriture de tests frontend dans GeoNature se base sur l’outil <a class="reference external" href="https://www.cypress.io/">Cypress</a> dont il est necessaire de maitriser et comprendre le fonctionnement.</p>
<p>Principe de base ; Un test doit être concis.
Il vaut mieux écrire plusieurs tests pour tester différentes configurations plutôt qu’un seul les testant toutes d’un coup.
Cela permet d’identifier plus précisément le test qui n’a pas fonctionné.</p>
<section id="redaction">
<h3>Rédaction<a class="headerlink" href="#redaction" title="Lien permanent vers cette rubrique"></a></h3>
<p>La rédaction des fichiers de tests se fait dans le dossier frontend/cypress/integration.</p>
<section id="structure">
<h4>Structure<a class="headerlink" href="#structure" title="Lien permanent vers cette rubrique"></a></h4>
<p>La nomenclature des fichiers de test est XXXXXXX-spec.js (XXXX correspondant au nom du module testé).</p>
<p>Dans chaque fichier la structure des tests est de la forme</p>
<ul class="simple">
<li><dl class="simple">
<dt>une description</dt><dd><ul>
<li><p>test</p></li>
<li><p>test</p></li>
<li><p>…</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="id4">
<h4>Exemple<a class="headerlink" href="#id4" title="Lien permanent vers cette rubrique"></a></h4>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;description général de la partie testée&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;description du test 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//contenu du test 1</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;description du test 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//contenu du test 2</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>

<span class="p">})</span><span class="w"></span>
</pre></div>
</div>
<p>Afin d’homogénéiser les descriptions des tests il est établi que l’on nomme un test en anglais en commençant par should.</p>
</section>
<section id="id5">
<h4>Exemple<a class="headerlink" href="#id5" title="Lien permanent vers cette rubrique"></a></h4>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should change the state&#39;</span><span class="p">,()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">...</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="implementation">
<h4>Implémentation<a class="headerlink" href="#implementation" title="Lien permanent vers cette rubrique"></a></h4>
<p>La réalisation des tests frontend passe par la sélection des objets HTML du DOM.
A fin de rendre ces sélections plus propres, on peut ajouter des tags HTML dans le dom.
Angular suggère l’ajout de tags de ce type:</p>
<ul class="simple">
<li><p>data-qa</p></li>
<li><p>test-qa</p></li>
<li><p>data-test</p></li>
</ul>
</section>
<section id="id6">
<h4>Exemple<a class="headerlink" href="#id6" title="Lien permanent vers cette rubrique"></a></h4>
<div class="highlight-HTML notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">data-qa</span><span class="o">=</span><span class="s">&quot;text_de_selection&quot;</span><span class="p">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="lancement">
<h3>Lancement<a class="headerlink" href="#lancement" title="Lien permanent vers cette rubrique"></a></h3>
<p>Pour lancer Cypress et executer les tests à la main il faut exécuter la commande (nécessite qu’une instance GeoNature fonctionne (backend+frontend)):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ npm run cypress:open
</pre></div>
</div>
<p>Pour lancer les test en mode automatique, il faut exécuter la commande (utilisée dans l’intégration continue (GitHub Action)):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ npm run e2e:ci <span class="o">&amp;&amp;</span> npm run e2e:coverage
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pied de page">
        <a href="import-level-2.html" class="btn btn-neutral float-left" title="IMPORT NIVEAU 2" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Précédent</a>
        <a href="versions-compatibility.html" class="btn btn-neutral float-right" title="COMPATIBILITE" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2019, PnE, PnC.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>